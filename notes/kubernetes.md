 # features
* manages containers effectively 
* service discovery and load balancing
* storage orchestration
* Automated rollouts and rollbacks
* self healing
* API
* Autoscaling apps

# Info 
* M -> master
* * kube|cloud-contol-manger
* * apiserver
* * scheduler
* * etcd (saves cluster state)
* Cluster -> nodes (M/W) -> pods -> container
* Contexts = profile config for a cluster
* labels must match
* pod comms with container but need service to comm to other pods with the service name:port
* pods IP changes
* services (clusterIP) have persistent IP, static dns, [servicename].[namespace].svc.cluster.local
* pods can't self heal deployments can
* nodeports exposes nodes to the public IP via a service (clusterIP), range 30000-32767
* load balancers allow comms on L4
* ingress allows comms on L7
* Volumes stores containers  to external storage
* * persitent volumes -> storage resource
* * persitent volume claim -> one to one mapping to a persistent volume and can be used by one or more pods
* * default relcaim policy is set to delete upon pod deletion
* * storage class allows pvc to be claimed by multiple pods
* config maps are a way to load variables 
* * static requires containers to be restarted
* * dynamic requires a volume to be mounted
* Secrets are base64 encoded variables (can be static and dynamic like configmaps)
* Probes helps monitor your app running in a container on a pod
* * types -> readinessProbe (stop accepting traffic), livenessProbe (periodic health check, restart if failed), startupProb
* * actions -> ExecAction, TCPSocketAction, HTTPGetAction

## Workload
* app running
* Pod,ReplicaSet,Deployment,StatefulSet,DaemonSet,Job|CronJob
## ReplicaSet
* multiple pods
* manually/automatically created
## Deployments
* manages automatic replica sets
* revisionHistoryLimit
* strategy -> rolling(Update), Recreate (Kills)
## DaemonSet
* runs deployment on every worker node
## Stateful set
* uses persistent volumes to keep data after pod deletion
## Job
* runs until a certain number of completion
## Cronjobs
* like linux cronjobs

# Install
## Enable legacy iptables
* iptables -F
* update-alternatives --set iptables /usr/sbin/iptables-legacy
* update-alternatives --set ip6tables /usr/sbin/ip6tables-legacy
## K3S install (light weight k8s)
### Master
* curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" sh -s -
* cat /var/lib/rancher/k3s/server/node-token -> for joining nodes
### Worker
* curl -sfL https://get.k3s.io | K3S_TOKEN="<token>" K3S_URL="https://<ip>:6443" K3S_NODE_NAME="k3s-node1" sh -

* config in `/etc/rancher/k3s/k3s.yaml` \*

# Usage
## Contexts
* kubectl config current-context
* kubectl config get-contexts
* kubectl config use-context [context_name]
* kubectl config delete-context [context_name]
* kubectl get nodes
* kubectl describe node

## Imperative way
* kubectl create deployment mynginx1 --image=nginx
* kubectl run [PodName] --image=busybox -- /bin/sh -c "sleep 5000"
* kubectl run mybox --image=busybox -it -- /bin/sh

# Declarative
* kubectl create -f deploy-example.yaml
* kubectl create -f myapp.yaml (pods)
* kubectl exec -it myapp-pod -- bash
* kubectl exec -it myapp-pod --container mybox -- bash
* init containers runs container before main container (yaml below)
* kubectl apply -f deploy.yaml
* kubectl delete -f deploy.yaml

* kubectl get deploy
* kubectl delete deploy [Name]
* kubectl get ns (namespace)
* kubectl create|delete [Name]
* kubectl config set-context --current --namespace=[Name]
* kubectl get pods --all-namespaces|-n [Name]
* kubectl get pods | -o wide
* kubectl describe pod [Name]
* kubctl get pod [podname] -o yaml > file.yaml
* kubectl delete -f myapp.yaml
* kubectl delete pod [podname] --grace-period=0 --force
* kubectl port-forward service/myservice 8080:80
* kubectl get ep myservice (endpoint)
* kubectl get rs (replicaSet)
* kubectl describe rs [Name]
* kubectl delete rs [Name]
* kubectl get ds (daemonSet)
* kubectl get sts (statefulSet)
* kubectl get job
* kubectl get cronjob|cj
* kubectl logs [podName]
* kubectl rollout status
* kubectl rollout history deployment/[deploymentName]
* kubectl rollout undo [deploymentName] | --to-revision=[revision#]
* kubectl get svc (services)
* kubectl get pv (persistent volume)
* kubectl get pvc (persitent voulme claim)
* kubectl get sc (storage class)
* kubectl get cm (config map)
* kubectl get secrets | secrets -o YAML
* kubectl autoscale deployment hpa-deployment --cpu-percent=50 --min=1 --max=4

deploy-example.yaml
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mynginx2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
      env: prod
  template:
    metadata:
      labels:
        app: nginx
        env: prod
    spec:
      containers:
      - name: nginx
        image: nginx
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi        
        ports:
        - containerPort: 80
```

myapp.yaml
```
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: myapp
    type: front-end
spec:
  containers:
  - name: nginx-container
    image: nginx
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi    
    ports:
    - containerPort: 80
      name: http
      protocol: TCP
    env:
    - name: DBCON
      value: myconnectionstring
```

initcontainers
```
apiVersion: v1
kind: Pod
metadata:
  name: init-demo
spec:
  containers:
  - name: nginx
    image: nginx
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi  
    ports:
    - containerPort: 80
    volumeMounts:
    - name: workdir
      mountPath: /usr/share/nginx/html
  initContainers:
  - name: install
    image: busybox
    command:
    - wget
    - "-O"
    - "/work-dir/index.html"
    - http://info.cern.ch
    volumeMounts:
    - name: workdir
      mountPath: "/work-dir"
  volumes:
  - name: workdir
    emptyDir: {}
```

replicaSets
```
apiVersion: apps/v1
kind: ReplicaSet
metadata:
 name: rs-example
spec:
 replicas: 3
 selector:
   matchLabels:
     app: nginx
     type: front-end
 template: 
   metadata:
     labels:
       app: nginx
       type: front-end
   spec:
     containers:
     - name: nginx
       image: nginx:alpine
       resources:
         requests:
           cpu: 100m
           memory: 128Mi
         limits:
           cpu: 250m
           memory: 256Mi 
       ports:
       - containerPort: 80
```

daemonSets
```
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: daemonset-example
  labels:
    app: daemonset-example
spec:
  selector:
    matchLabels:
      app: daemonset-example
  template:
    metadata:
      labels:
        app: daemonset-example
    spec:
      tolerations:
      - key: node-role.kubernetes.io/master
        effect: NoSchedule
      containers:
      - name: busybox
        image: busybox
        args:
        - sleep
        - "10000"
```

statefulSet
```
apiVersion: v1
kind: Service
metadata:
  name: nginx-headless
  labels:
    run: nginx-sts-demo
spec:
  ports:
  - port: 80
    name: web
  clusterIP: None
  selector:
    run: nginx-sts-demo
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nginx-sts
spec:
  serviceName: nginx-headless
  replicas: 3
  selector:
    matchLabels:
      run: nginx-sts-demo
  template:
    metadata:
      labels:
        run: nginx-sts-demo
    spec:
      containers:
      - name: nginx
        image: nginx
        volumeMounts:
        - name: www
          mountPath: /var/www/
  volumeClaimTemplates:
  - metadata:
      name: www
    spec:
      storageClassName: hostpath
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Mi
```

jobs
```
apiVersion: batch/v1
kind: Job
metadata:
  name: hello
spec:
  template:
    spec:
      containers:
      - name: busybox
        image: busybox
        command: ["echo", "Hello from the Job"]
      restartPolicy: Never
```

cronjobs
```
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello-cron
spec:
  schedule: "* * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: busybox
            image: busybox
            command: ["echo", "Hello from the CronJob"]
          restartPolicy: Never
```


rollback
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-dep
  namespace: default
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: hello-dep
  template:
    metadata:
      labels:
        app: hello-dep
    spec:
      containers:
      - image: k8sacademy/hello-app:1.0
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 256Mi      
        imagePullPolicy: Always
        name: hello-dep
        ports:
        - containerPort: 8080
```

clusterIP (service to access ports from diff pods)
```
apiVersion: v1
kind: Service
metadata:
 name: svc-example
spec:
  ports:
  - port: 8080
    targetPort: 80
  selector:
    app: app-example
    env: prod
```
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-example
spec:
  replicas: 3
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: app-example
      env: prod
  template:
    metadata:
      labels:
        app: app-example
        env: prod
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
```
```
apiVersion: v1
kind: Pod
metadata:
  name: mybox
spec:
  restartPolicy: Always
  containers:
  - name: mybox
    image: busybox
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi    
    command:
      - sleep
      - "3600"
```
access the nginx server from the busybox with the name `wget -qO- http://svc-example:8080`

nodeport (use selector for deployment)
```
apiVersion: v1
kind: Service
metadata:
  name: svc-example
spec:
  type: NodePort
  selector:
    app: nginx
    env: prod
  ports:
  - nodePort: 32410
    protocol: TCP
    port: 80
    targetPort: 80

```

loadbalancer
```
apiVersion: v1
kind: Service
metadata:
  name: svc-example
spec:
  type: LoadBalancer
  selector:
    app: nginx
    env: prod
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 80
```

persistent volume
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv001
  labels:
    type: local
spec:
  storageClassName: ssd 
  capacity:
    storage: 10Mi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  hostPath:
    path: "/data/"
```

persistent volume claim
```
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Mi
  storageClassName: ssd
```

use persistent volume claim
```
apiVersion: v1
kind: Pod
metadata:
  name: mybox
spec:
  restartPolicy: Always
  containers:
  - name: mybox
    image: busybox
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi    
    command:
      - sleep
      - "3600"
    volumeMounts:
      - mountPath: "/demo/"
        name: mypd
  volumes:
    - name: mypd
      persistentVolumeClaim:
        claimName: myclaim

```

config map
```
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-example
data:
  state: Michigan
  city: Ann Arbor

```

use config map
```
apiVersion: v1
kind: Pod
metadata:
  name: mybox
spec:
  restartPolicy: Always
  containers:
  - name: mybox
    image: busybox
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi    
    command:
      - sleep
      - "3600"
    env:
      - name: CITY
        valueFrom:
          configMapKeyRef:
            name: cm-example
            key: city


```

secrets
```
apiVersion: v1
kind: Secret
metadata:
  name: secrets
type: Opaque
data:
  username: VGhlVXNlck5hbWU=
  password: bXlwYXNzd29yZA==
           

```

use secrets
```
apiVersion: v1
kind: Pod
metadata:
  name: mybox
spec:
  restartPolicy: Always
  containers:
  - name: mybox
    image: busybox
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi    
    command:
      - sleep
      - "3600"
    env:
      - name: USERNAME
        valueFrom:
          secretKeyRef:
            name: secrets
            key: username
      - name: PASSWORD
        valueFrom:
          secretKeyRef:
            name: secrets
            key: password            

```

livenessProbe
```
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-example
spec:
  containers:
  - name: liveness
    image: busybox
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi    
    args:
    - /bin/sh
    - -c
    - touch /tmp/healthy; sleep 15; rm -rf /tmp/healthy; sleep 3600
    livenessProbe:
      exec:
        command:
        - cat
        - /tmp/healthy
      initialDelaySeconds: 5
      periodSeconds: 5
      failureThreshold: 2
```

